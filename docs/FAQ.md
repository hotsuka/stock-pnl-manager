# よくある質問 (FAQ)

Stock P&L Managerに関するよくある質問と回答

## 目次

1. [一般的な質問](#一般的な質問)
2. [インストール・セットアップ](#インストールセットアップ)
3. [CSV取り込み](#csv取り込み)
4. [株価・データ更新](#株価データ更新)
5. [損益計算](#損益計算)
6. [パフォーマンス・ベンチマーク](#パフォーマンスベンチマーク)
7. [エラー対処法](#エラー対処法)
8. [技術的な質問](#技術的な質問)

---

## 一般的な質問

### Q1. Stock P&L Managerとは何ですか?

**A**: 株式ポートフォリオの損益を管理するWebアプリケーションです。証券会社の取引履歴CSVをアップロードすることで、保有銘柄の損益、配当履歴、パフォーマンス分析、ベンチマーク比較などを自動で計算・可視化します。

**主な機能**:
- CSV取り込み
- 移動平均法による損益計算
- 株価・配当データの自動更新
- パフォーマンス分析
- ベンチマーク比較 (日経平均・S&P500)
- 株式評価指標表示 (PER、PBR等)

---

### Q2. どの証券会社のCSVに対応していますか?

**A**: 現在、以下の形式に対応しています:

**日本株**:
- SBI証券
- 楽天証券
- マネックス証券
- 野村證券

**米国株**:
- SBI証券の米国株取引履歴
- 楽天証券の米国株取引履歴

**必須カラム**:
- 取引日
- ティッカーシンボル (または銘柄コード)
- 取引区分 (買付/売却)
- 数量
- 単価
- 受渡金額

詳細は [USER_GUIDE.md](USER_GUIDE.md) を参照してください。

---

### Q3. オフラインで使用できますか?

**A**: 部分的に可能です。

**オフライン可能な機能**:
- 既に取り込んだ取引データの閲覧
- 保有銘柄・損益の表示
- グラフの表示

**オンライン必須の機能**:
- 株価の更新 (Yahoo Finance API使用)
- 配当データの取得
- 為替レートの取得
- 株式評価指標の更新

---

### Q4. データはどこに保存されますか?

**A**: すべてのデータはローカルのSQLiteデータベースに保存されます。

**保存場所**: `data/stock_pnl.db`

**特徴**:
- クラウドにデータは送信されません
- 個人情報は完全にローカル管理
- バックアップは手動で実施

バックアップ方法については [USER_GUIDE.md - メンテナンス](USER_GUIDE.md#メンテナンス) を参照してください。

---

## インストール・セットアップ

### Q5. Pythonのバージョンはいくつが必要ですか?

**A**: Python 3.8以上が必要です。推奨は**Python 3.10以上**です。

**確認方法**:
```bash
python --version
```

**インストール**:
- Windows: [python.org](https://www.python.org/downloads/)
- macOS: `brew install python3`
- Linux: `sudo apt install python3 python3-pip`

---

### Q6. インストール中に「pip install」でエラーが出ます

**A**: よくあるエラーと対処法:

**エラー1: `Microsoft Visual C++ 14.0 is required` (Windows)**

**対処法**:
1. [Visual Studio Build Tools](https://visualstudio.microsoft.com/downloads/) をインストール
2. または、事前ビルド版のパッケージを使用:
```bash
pip install --only-binary :all: pandas numpy
```

**エラー2: `Permission denied`**

**対処法**:
```bash
# ユーザー領域にインストール
pip install --user -r requirements.txt
```

**エラー3: `Command "python setup.py egg_info" failed`**

**対処法**:
```bash
# pipとsetuptoolsをアップグレード
pip install --upgrade pip setuptools

# 再度インストール
pip install -r requirements.txt
```

---

### Q7. 起動時に「Address already in use」エラーが出ます

**A**: ポート5000が既に使用されています。

**対処法1: 別のポートを使用**
```bash
# run.pyを編集
app.run(debug=True, host='0.0.0.0', port=5001)
```

**対処法2: 既存のプロセスを終了**

**Windows**:
```bash
# ポート5000を使用しているプロセスを確認
netstat -ano | findstr :5000

# プロセスを終了 (PIDは上記コマンドで確認)
taskkill /PID <PID> /F
```

**macOS/Linux**:
```bash
# ポート5000を使用しているプロセスを終了
lsof -ti:5000 | xargs kill -9
```

---

## CSV取り込み

### Q8. CSVアップロードで「エンコードエラー」が出ます

**A**: CSVファイルのエンコードが対応していない可能性があります。

**対処法**:

1. **Shift-JIS → UTF-8に変換**
   - Excelで開く → 「名前を付けて保存」 → エンコード: UTF-8

2. **手動でエンコードを確認**
```bash
# Windowsの場合 (PowerShell)
Get-Content <ファイル名> -Encoding Default | Set-Content <ファイル名> -Encoding UTF8

# macOS/Linuxの場合
iconv -f SHIFT-JIS -t UTF-8 <元ファイル> > <新ファイル>
```

---

### Q9. CSVアップロード後、一部の取引がスキップされます

**A**: 以下の理由が考えられます:

**原因1: 重複取引**
- 同じ日付、ティッカー、数量、単価の取引は重複とみなされます

**対処法**:
- ダッシュボードで取引履歴を確認
- 既に登録されている取引はスキップされます (正常動作)

**原因2: 必須項目の不足**
- 取引日、ティッカー、数量、単価のいずれかが欠損

**対処法**:
- CSVファイルを開いて欠損データを確認
- 必須項目をすべて埋めて再アップロード

**原因3: データ形式エラー**
- 数値が文字列になっている (例: "1,000"にカンマ)

**対処法**:
- カンマを削除 ("1,000" → "1000")
- 通貨記号を削除 ("¥1000" → "1000")

---

### Q10. 外国株の為替レートが正しく反映されません

**A**: 為替レートの設定を確認してください。

**確認ポイント**:

1. **CSVに為替レート列があるか**
   - `exchange_rate` または `為替レート` 列が必要

2. **為替レートの形式**
   - 正: `150.25` (数値)
   - 誤: `150.25円/$` (テキスト)

3. **通貨コードの設定**
   - `currency` 列が `USD` になっているか確認

**手動で為替レートを更新**:
```bash
python scripts/update_prices_manual.py
```

---

## 株価・データ更新

### Q11. 株価が更新されません

**A**: 以下を確認してください:

**確認1: インターネット接続**
- Yahoo Finance APIにアクセスできるか確認
- ブラウザで https://finance.yahoo.com/ が開けるか確認

**確認2: ティッカーシンボルの形式**
- 日本株: `7203.T` (末尾に`.T`)
- 米国株: `AAPL` (そのまま)

**確認3: 営業日かどうか**
- 休日・休場日は株価が更新されません
- 前営業日の終値が表示されます

**手動更新**:
ダッシュボードで「株価を更新」ボタンをクリック

---

### Q12. 一部の銘柄だけ株価が取得できません

**A**: Yahoo Financeに該当ティッカーのデータがない可能性があります。

**対処法**:

1. **ティッカーシンボルを確認**
   - 上場廃止銘柄
   - ティッカー変更された銘柄

2. **Yahoo Financeで検索**
   - https://finance.yahoo.com/ で直接検索
   - データが存在するか確認

3. **手動で株価を入力**
   - データベースを直接編集 (開発者向け)

---

### Q13. 配当データが表示されません

**A**: 配当データの取得には時間がかかることがあります。

**対処法**:

1. **手動で配当データを更新**
```bash
python scripts/update_dividends.py
```

2. **配当履歴を確認**
   - 配当がない銘柄もあります
   - Yahoo Financeに配当データがない場合は取得できません

3. **権利落ち日の確認**
   - 配当は「権利落ち日 (ex-date)」で記録されます

---

### Q14. 株価更新が遅いです

**A**: Yahoo Finance APIのレート制限により、大量の銘柄を一度に更新すると時間がかかります。

**改善策**:

1. **夜間に自動更新を設定**
   - cron (Linux/macOS) またはタスクスケジューラ (Windows) で定期実行

2. **保有銘柄のみ更新**
   - デフォルトでは保有銘柄のみ更新されます

3. **API呼び出し回数を減らす**
   - 1日1回の更新で十分です

---

## 損益計算

### Q15. 損益計算の方法は?

**A**: **移動平均法**を使用しています。

**計算ロジック**:

1. **買付時**: 加重平均で平均取得単価を更新
```
新平均単価 = (既存総取得コスト + 新規取得コスト) / (既存数量 + 新規数量)
```

2. **売却時**: 平均取得単価を使用して確定損益を計算
```
確定損益 = 売却金額 - (平均取得単価 × 売却数量)
```

3. **未実現損益**: 現在株価と平均取得単価の差
```
未実現損益 = (現在株価 - 平均取得単価) × 保有数量
```

詳細は [DEVELOPER_GUIDE.md - ビジネスロジック](DEVELOPER_GUIDE.md#ビジネスロジック) を参照してください。

---

### Q16. 手数料は損益に含まれますか?

**A**: はい、**含まれます**。

**買付時**:
- 手数料は取得コストに加算されます
- `受渡金額 = 数量 × 単価 + 手数料`

**売却時**:
- 手数料は売却金額から差し引かれます
- `受渡金額 = 数量 × 単価 - 手数料`

**確認方法**:
- CSVに `commission` (手数料) 列があることを確認
- または `settlement_amount` (受渡金額) が正確であること

---

### Q17. 外国株の損益は円建てですか?ドル建てですか?

**A**: **すべて円建て**で計算されます。

**計算方法**:
1. 取引時の為替レートでドル → 円に換算
2. 円建てで取得コストを記録
3. 現在の株価も為替レートで円換算
4. 円建てで損益を計算

**メリット**:
- 日本株と米国株を合算して総損益を把握できる
- 為替差損益も自動的に反映される

---

### Q18. 分割・併合された銘柄の損益はどうなりますか?

**A**: 現在、**自動では対応していません**。

**対処法**:

1. **手動で取引データを修正**
   - 分割比率に応じて数量・単価を調整

2. **再計算を実行**
```bash
python scripts/recalculate_all.py
```

**例: 1:2の株式分割**
- 数量: 100株 → 200株
- 単価: 1000円 → 500円
- 総取得コスト: 変わらず

---

## パフォーマンス・ベンチマーク

### Q19. パフォーマンス計算の仕組みは?

**A**: 以下の要素を合計して計算します:

```
総リターン = 確定損益 + 未実現損益 + 配当金合計
リターン率 = 総リターン / 総投資額 × 100
```

**期間リターン**:
- 開始日と終了日を指定して期間内のリターンを計算
- 期間内の取引・配当のみを集計

---

### Q20. ベンチマークと比較するにはどうすればいいですか?

**A**: ダッシュボードの「ベンチマーク比較」タブで確認できます。

**対応ベンチマーク**:
- 日経平均株価 (`^N225`)
- S&P500 (`^GSPC`)

**比較指標**:
- リターン率 (%)
- 最大ドローダウン
- シャープレシオ (実装予定)

**注意**:
- ベンチマークはポートフォリオ開始日から自動取得されます
- 初回は数分かかる場合があります

---

### Q21. 配当込みリターンと株価リターンの違いは?

**A**:

**配当込みリターン (Total Return)**:
- 株価の値上がり益 + 配当金を含む
- 実際の投資成果を正確に反映

**株価リターン (Price Return)**:
- 株価の値上がり益のみ
- 配当を含まない

**例**:
- 投資額: 100万円
- 株価上昇: +5万円
- 配当金: +2万円
- 配当込みリターン: +7% (7万円 / 100万円)
- 株価リターン: +5% (5万円 / 100万円)

本アプリでは**配当込みリターン**を表示しています。

---

## エラー対処法

### Q22. 「データベースエラー」が表示されます

**A**: データベースファイルが破損している可能性があります。

**対処法**:

1. **バックアップから復元**
```bash
python scripts/restore_database.py backups/stock_pnl_20260110.db
```

2. **データベースを再構築**
```bash
# 既存データベースをバックアップ
cp data/stock_pnl.db data/stock_pnl_backup.db

# マイグレーションをリセット
flask db downgrade base
flask db upgrade
```

3. **CSVを再インポート**

---

### Q23. ページが真っ白になります

**A**: JavaScriptエラーの可能性があります。

**対処法**:

1. **ブラウザのコンソールを確認**
   - F12キーを押して「Console」タブを確認
   - エラーメッセージを確認

2. **ブラウザのキャッシュをクリア**
   - Ctrl+Shift+Delete (Windows)
   - Cmd+Shift+Delete (macOS)

3. **別のブラウザで試す**
   - Chrome、Firefox、Edgeなど

4. **アプリを再起動**
```bash
# アプリを停止 (Ctrl+C)
# 再度起動
python run.py
```

---

### Q24. グラフが表示されません

**A**: Plotlyライブラリの問題かネットワーク接続の問題です。

**対処法**:

1. **オフラインモードの確認**
   - グラフ描画にはPlotly CDNが必要
   - インターネット接続を確認

2. **Plotlyを再インストール**
```bash
pip uninstall plotly
pip install plotly==5.18.0
```

3. **ブラウザの互換性確認**
   - 最新版のブラウザを使用
   - Internet Explorerは非対応

---

### Q25. 「500 Internal Server Error」が出ます

**A**: サーバー側のエラーです。

**対処法**:

1. **ログファイルを確認**
```bash
# ログファイルを表示
cat logs/app.log

# または最新100行を表示
tail -100 logs/app.log
```

2. **エラーメッセージを確認**
   - ブラウザに表示されるエラー詳細を確認
   - デバッグモードを有効化 (開発環境のみ):
```python
# run.py
app.run(debug=True)
```

3. **よくある原因**
   - データベース接続エラー
   - 外部APIタイムアウト
   - メモリ不足

---

## 技術的な質問

### Q26. 複数のポートフォリオを管理できますか?

**A**: 現在は**1つのポートフォリオのみ**対応しています。

**回避策**:

1. **複数のデータベースを使用**
```bash
# ポートフォリオAの起動
DATABASE_URL=sqlite:///data/portfolio_a.db python run.py

# ポートフォリオBの起動 (別ターミナル)
DATABASE_URL=sqlite:///data/portfolio_b.db python run.py --port 5001
```

2. **将来の拡張予定**
   - ポートフォリオ選択機能の追加を検討中

---

### Q27. APIを外部から呼び出せますか?

**A**: はい、REST APIが提供されています。

**エンドポイント例**:
```bash
# 保有銘柄一覧を取得
curl http://localhost:5000/api/holdings

# 特定銘柄の株価を更新
curl -X POST http://localhost:5000/api/stock-price/update \
  -H "Content-Type: application/json" \
  -d '{"ticker": "7203.T"}'
```

詳細は [API_REFERENCE.md](API_REFERENCE.md) を参照してください。

---

### Q28. Dockerで実行できますか?

**A**: 現在準備中です。

**Phase 12で実装予定**:
- Dockerfileの作成
- docker-compose.ymlの作成
- ワンコマンドでの起動

**完成予定**: 2026年1月中旬

---

### Q29. クラウドにデプロイできますか?

**A**: はい、以下のプラットフォームに対応可能です:

**対応予定**:
- Heroku
- AWS (EC2, Elastic Beanstalk)
- Google Cloud Platform (App Engine)
- Azure (App Service)

**注意**:
- SQLiteは単一サーバー向けです
- 本格的なデプロイにはPostgreSQL等への移行を推奨

詳細は [DEPLOYMENT.md](DEPLOYMENT.md) (準備中) を参照してください。

---

### Q30. ソースコードをカスタマイズできますか?

**A**: はい、オープンソースです。

**カスタマイズ例**:
- 新しい評価指標の追加
- 独自のベンチマークの追加
- グラフのデザイン変更
- 新しい証券会社のCSV形式に対応

**開発ガイド**:
[DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md) を参照してください。

**コントリビューション**:
Pull Requestを歓迎します!

---

## サポート

### その他の質問がある場合

1. **GitHubで Issue を作成**: [GitHub Issues](https://github.com/your-repo/stock-pnl-manager/issues)
2. **ドキュメントを確認**:
   - [USER_GUIDE.md](USER_GUIDE.md)
   - [DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md)
   - [API_REFERENCE.md](API_REFERENCE.md)

---

**最終更新**: 2026-01-11
**バージョン**: 1.0.0

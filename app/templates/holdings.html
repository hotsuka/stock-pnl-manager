{% extends "base.html" %}

{% block title %}保有銘柄一覧 - Stock P&L Manager{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-top: 20px;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    #holdings-tfoot tr {
        border-top: 2px solid #dee2e6;
        font-weight: bold;
    }

    #holdings-tfoot td {
        padding: 12px 8px;
    }

    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }

    .sortable:hover {
        background-color: #f8f9fa;
    }

    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }

    .sortable.asc::after {
        content: '▲';
        opacity: 1;
    }

    .sortable.desc::after {
        content: '▼';
        opacity: 1;
    }

    .positive {
        color: #28a745;
    }

    .negative {
        color: #dc3545;
    }

    /* Sticky Header 修正版 */
    .table-responsive {
        overflow: visible !important;
        /* ウィンドウスクロールでの sticky を有効化 */
    }

    #holdings-table thead th {
        position: sticky;
        top: 56px;
        /* ナビゲーションバーの高さ (Bootstrap default 56px) に調整 */
        background-color: #fff !important;
        /* 背景色を強制（不透明化） */
        z-index: 1020;
        /* ナビゲーションバー(1030)より下、他要素より上 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        /* 下部に影をつけて境界を明示 */
        border-bottom: 2px solid #dee2e6;
    }

    /* ソート可能なヘッダーのホバー色も sticky 維持のため調整 */
    #holdings-table thead th.sortable:hover {
        background-color: #f8f9fa !important;
    }

    /* 評価指標テーブルのSticky Header */
    #metrics1-table thead th,
    #metrics2-table thead th {
        position: sticky;
        top: 56px;
        background-color: #fff !important;
        z-index: 1020;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-bottom: 2px solid #dee2e6;
    }

    #metrics1-table thead th.sortable:hover,
    #metrics2-table thead th.sortable:hover {
        background-color: #f8f9fa !important;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="holdings-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>保有銘柄一覧</h1>
        <div class="d-flex gap-3 align-items-center">
            <!-- フィルターボタン -->
            <div class="btn-group" role="group" aria-label="株式フィルター">
                <button type="button" class="btn btn-outline-secondary active" id="filter-all" onclick="setFilter('all')">
                    すべて
                </button>
                <button type="button" class="btn btn-outline-secondary" id="filter-jp" onclick="setFilter('jp')">
                    日本株
                </button>
                <button type="button" class="btn btn-outline-secondary" id="filter-foreign" onclick="setFilter('foreign')">
                    外国株
                </button>
            </div>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i> データを更新
            </button>
        </div>
    </div>

    <!-- タブナビゲーション -->
    <ul class="nav nav-tabs mb-3" id="holdingsTabs">
        <li class="nav-item">
            <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab"
                    data-bs-target="#basic-info">基本情報</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="metrics1-tab" data-bs-toggle="tab"
                    data-bs-target="#metrics1">評価指標1</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="metrics2-tab" data-bs-toggle="tab"
                    data-bs-target="#metrics2">評価指標2</button>
        </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content">
        <!-- 基本情報タブ -->
        <div class="tab-pane fade show active" id="basic-info">
            <div class="table-container">
                <!-- 為替レート表示 -->
                <div class="alert alert-info mb-3" id="exchange-rates-display" style="display: none;">
                    <strong>換算為替レート:</strong>
                    <span id="exchange-rates-text">読み込み中...</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="holdings-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('ticker_symbol')">ティッカー</th>
                                <th class="sortable" onclick="sortTable('security_name')">銘柄名</th>
                                <th class="text-end">保有数量</th>
                                <th class="text-end">平均取得単価</th>
                                <th class="text-end">現在株価</th>
                                <th class="sortable text-end" onclick="sortTable('total_cost')">取得コスト</th>
                                <th class="sortable text-end" onclick="sortTable('current_value')">評価額</th>
                                <th class="sortable text-end" onclick="sortTable('unrealized_pnl')">未実現損益</th>
                                <th class="sortable text-end" onclick="sortTable('unrealized_pnl_pct')">損益率</th>
                                <th class="sortable text-end" onclick="sortTable('irr')">IRR</th>
                                <th class="sortable text-end" onclick="sortTable('day_change_pct')">対前日変動率</th>
                            </tr>
                        </thead>
                        <tbody id="holdings-tbody">
                            <tr>
                                <td colspan="11" class="text-center">
                                    <div class="loading">データを読み込み中...</div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot id="holdings-tfoot" class="table-light d-none">
                            <tr>
                                <td colspan="5" class="text-end"><strong>合計</strong></td>
                                <td class="text-end" id="total-cost"><strong>-</strong></td>
                                <td class="text-end" id="total-value"><strong>-</strong></td>
                                <td class="text-end" id="holdings-total-pnl"><strong>-</strong></td>
                                <td class="text-end" id="holdings-total-pnl-pct"><strong>-</strong></td>
                                <td class="text-end" id="holdings-total-irr"><strong>-</strong></td>
                                <td class="text-end" id="holdings-total-day-change"><strong>-</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- 評価指標1タブ (バリュエーション指標) -->
        <div class="tab-pane fade" id="metrics1">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover" id="metrics1-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortMetrics1Table('ticker_symbol')">ティッカー</th>
                                <th class="sortable" onclick="sortMetrics1Table('security_name')">銘柄名</th>
                                <th class="sortable text-end" onclick="sortMetrics1Table('current_price')">株価</th>
                                <th class="sortable text-end" onclick="sortMetrics1Table('market_cap')">時価総額</th>
                                <th class="sortable text-end" onclick="sortMetrics1Table('beta')">Beta</th>
                                <th class="sortable text-end" onclick="sortMetrics1Table('pe_ratio')">PER</th>
                                <th class="sortable text-end" onclick="sortMetrics1Table('pb_ratio')">PBR</th>
                                <th class="sortable text-end" onclick="sortMetrics1Table('eps')">EPS</th>
                                <th class="sortable text-end" onclick="sortMetrics1Table('ev_to_revenue')">EV/売上</th>
                                <th class="sortable text-end" onclick="sortMetrics1Table('ev_to_ebitda')">EV/EBITDA</th>
                            </tr>
                        </thead>
                        <tbody id="metrics1-tbody">
                            <tr>
                                <td colspan="10" class="text-center">
                                    <div class="loading">評価指標1タブを選択すると、データが読み込まれます</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 評価指標2タブ (パフォーマンス指標) -->
        <div class="tab-pane fade" id="metrics2">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover" id="metrics2-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortMetrics2Table('ticker_symbol')">ティッカー</th>
                                <th class="sortable" onclick="sortMetrics2Table('security_name')">銘柄名</th>
                                <th class="sortable text-end" onclick="sortMetrics2Table('current_price')">株価</th>
                                <th class="sortable text-end" onclick="sortMetrics2Table('day_change_pct')">対前日変動率</th>
                                <th class="sortable text-end" onclick="sortMetrics2Table('ytd_return')">YTDリターン</th>
                                <th class="sortable text-end" onclick="sortMetrics2Table('one_year_return')">1年リターン</th>
                                <th>52週レンジ</th>
                                <th class="sortable text-end" onclick="sortMetrics2Table('revenue')">売上</th>
                                <th class="sortable text-end" onclick="sortMetrics2Table('profit_margin')">利益率</th>
                            </tr>
                        </thead>
                        <tbody id="metrics2-tbody">
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="loading">評価指標2タブを選択すると、データが読み込まれます</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let holdingsData = [];
    let metricsData = [];
    let irrData = {};
    let currentSortField = null;
    let currentSortDirection = 'asc';
    let exchangeRates = {};
    // 評価指標タブ用のソート状態
    let metrics1SortField = null;
    let metrics1SortDirection = 'asc';
    let metrics2SortField = null;
    let metrics2SortDirection = 'asc';
    // フィルター状態
    let currentFilter = 'all'; // 'all', 'jp', 'foreign'

    // ページ読み込み時にデータ取得
    document.addEventListener('DOMContentLoaded', function () {
        loadData();

        // タブ切替イベント - 評価指標1
        document.getElementById('metrics1-tab').addEventListener('shown.bs.tab', function() {
            if (metricsData.length === 0) {
                loadMetricsData();
            } else {
                renderMetrics1Table();
            }
        });

        // タブ切替イベント - 評価指標2
        document.getElementById('metrics2-tab').addEventListener('shown.bs.tab', function() {
            if (metricsData.length === 0) {
                loadMetricsData();
            } else {
                renderMetrics2Table();
            }
        });
    });

    // ティッカーから通貨を推測するヘルパー関数
    function inferCurrency(ticker, dbCurrency) {
        // 日本株（.Tで終わる）
        if (ticker.endsWith('.T')) return 'JPY';
        // 韓国株（.KSで終わる）
        if (ticker.endsWith('.KS')) return 'KRW';
        // 上記以外で、DBの通貨がJPYの場合は米国株と推測
        if (dbCurrency === 'JPY' && !ticker.includes('.')) return 'USD';
        // その他はDBの値を使用
        return dbCurrency;
    }

    // データの読み込み
    async function loadData() {
        // 1. まず保有銘柄データを取得
        await fetchHoldingsData();

        // 2. 保有銘柄の通貨リストを抽出して為替レートを取得
        if (holdingsData.length > 0) {
            const currencies = [...new Set(holdingsData.map(h => h.currency))].filter(c => c !== 'JPY' && c !== '日本円');
            if (currencies.length > 0) {
                await loadExchangeRates(currencies);
            }

            // 3. 為替レート取得後に損益を再計算（JPY換算のため）
            holdingsData = holdingsData.map(h => ({
                ...h,
                calculated_unrealized_pnl: calculateUnrealizedPnL(h),
                calculated_unrealized_pnl_pct: calculateUnrealizedPnLPct(h)
            }));
        }

        // 4. IRRデータを取得
        await loadIrrData();

        // 5. テーブル描画
        renderHoldingsTable();
    }

    // IRRデータの読み込み
    async function loadIrrData() {
        try {
            const response = await fetch('/api/holdings/irr');
            const result = await response.json();

            if (result.success) {
                irrData = result.irr_data;
                // holdingsDataにIRRを追加
                holdingsData = holdingsData.map(h => ({
                    ...h,
                    irr: irrData[h.ticker_symbol]?.irr || null
                }));
            }
        } catch (error) {
            console.error('IRRデータの読み込みエラー:', error);
        }
    }

    // 保有銘柄データの取得（描画はしない）
    async function fetchHoldingsData() {
        try {
            const response = await fetch('/api/holdings');
            const result = await response.json();

            if (result.success) {
                holdingsData = result.holdings.map(h => {
                    // ティッカーから正しい通貨を推測
                    const correctedCurrency = inferCurrency(h.ticker_symbol, h.currency);
                    const correctedHolding = {
                        ...h,
                        currency: correctedCurrency
                    };
                    return {
                        ...correctedHolding,
                        calculated_unrealized_pnl: calculateUnrealizedPnL(correctedHolding),
                        calculated_unrealized_pnl_pct: calculateUnrealizedPnLPct(correctedHolding)
                    };
                });
            }
        } catch (error) {
            console.error('保有銘柄データの読み込みエラー:', error);
            document.getElementById('holdings-tbody').innerHTML = '<tr><td colspan="10" class="text-center text-danger">データの読み込みに失敗しました</td></tr>';
        }
    }

    // 為替レートの読み込み
    async function loadExchangeRates(currencies = ['USD', 'KRW']) {
        try {
            const currencyStr = currencies.join(',');
            const response = await fetch(`/api/exchange-rate/multiple?currencies=${currencyStr}`);
            const result = await response.json();

            if (result.success) {
                exchangeRates = result.rates;
                displayExchangeRates();
            }
        } catch (error) {
            console.error('為替レートの読み込みエラー:', error);
        }
    }

    // 為替レートの表示
    function displayExchangeRates() {
        const display = document.getElementById('exchange-rates-display');
        const text = document.getElementById('exchange-rates-text');

        const rates = [];

        // Dynamic rates display
        if (exchangeRates) {
            Object.keys(exchangeRates).forEach(currentKey => {
                if (exchangeRates[currentKey] && exchangeRates[currentKey].rate) {
                    rates.push(`${currentKey}/JPY: ${exchangeRates[currentKey].rate.toFixed(2)}`);
                }
            });
        }

        if (rates.length > 0) {
            text.textContent = rates.join(' | ');
            display.style.display = 'block';
        }
    }

    // 通貨をJPYに換算
    function convertToJPY(amount, currency) {
        if (amount === null || amount === undefined) return null;

        const numAmount = parseFloat(amount);
        if (isNaN(numAmount)) return null;

        if (currency === 'JPY' || currency === '日本円') return numAmount;

        const rate = exchangeRates[currency]?.rate;
        if (!rate) return numAmount;

        return numAmount * rate;
    }

    // 株価を表示用にフォーマット（現在株価 + JPY換算 + 前日終値）
    function formatPriceWithPreviousClose(currentPrice, previousClose, currency) {
        if (!currentPrice) return '-';

        const priceStr = formatPrice(currentPrice, currency);
        let result = priceStr;

        // Add currency for foreign stocks
        if (currency !== 'JPY' && currency !== '日本円') {
            result += ` ${currency}`;

            // Add JPY conversion
            const jpyAmount = convertToJPY(currentPrice, currency);
            if (jpyAmount && jpyAmount !== currentPrice) {
                result += `<br><small>(${formatCurrency(jpyAmount)} JPY)</small>`;
            }
        }

        // Add previous close
        if (previousClose !== null && previousClose !== undefined) {
            result += `<br><small style="color: #6c757d;">(前日: ${formatPrice(previousClose, currency)})</small>`;
        }

        return result;
    }

    // 評価額を表示用にフォーマット（常にJPY）
    function formatValueInJPY(value, currency) {
        if (value === null || value === undefined) return '-';
        return formatCurrency(value); // Already JPY from DB
    }

    // 未実現損益率を計算（DBの値を信頼）
    function calculateUnrealizedPnL(holding) {
        return holding.unrealized_pnl !== null ? parseFloat(holding.unrealized_pnl) : null;
    }

    function calculateUnrealizedPnLPct(holding) {
        return holding.unrealized_pnl_pct !== null ? parseFloat(holding.unrealized_pnl_pct) : null;
    }

    // フィルターを設定
    function setFilter(filter) {
        currentFilter = filter;

        // ボタンの状態を更新
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`filter-${filter}`).classList.add('active');

        // テーブルを再描画
        renderHoldingsTable();

        // 評価指標タブも再描画（表示中の場合）
        if (metricsData.length > 0) {
            const activeTabId = document.querySelector('#holdingsTabs .nav-link.active')?.id;
            if (activeTabId === 'metrics1-tab') {
                renderMetrics1Table();
            } else if (activeTabId === 'metrics2-tab') {
                renderMetrics2Table();
            }
        }
    }

    // フィルタリングされたデータを取得
    function getFilteredData(data) {
        if (currentFilter === 'all') {
            return data;
        } else if (currentFilter === 'jp') {
            return data.filter(h => h.ticker_symbol.endsWith('.T'));
        } else if (currentFilter === 'foreign') {
            return data.filter(h => !h.ticker_symbol.endsWith('.T'));
        }
        return data;
    }

    function renderHoldingsTable() {
        const tbody = document.getElementById('holdings-tbody');

        // フィルタリング
        const filteredData = getFilteredData(holdingsData);

        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-center">保有銘柄がありません</td></tr>';
            document.getElementById('holdings-tfoot').classList.add('d-none');
            return;
        }

        tbody.innerHTML = filteredData.map(h => {
            const unrealizedPnL = calculateUnrealizedPnL(h);
            const unrealizedPnLPct = calculateUnrealizedPnLPct(h);
            const pnlClass = unrealizedPnL !== null && unrealizedPnL >= 0 ? 'positive' : 'negative';
            const irrClass = h.irr !== null && h.irr >= 0 ? 'positive' : 'negative';

            return `
                <tr>
                    <td><strong>${h.ticker_symbol}</strong></td>
                    <td>${h.security_name || '-'}</td>
                    <td class="text-end">${formatNumber(h.total_quantity)}</td>
                    <td class="text-end">${formatAverageCost(h)}</td>
                    <td class="text-end">${formatPriceWithPreviousClose(h.current_price, h.previous_close, h.currency)}</td>
                    <td class="text-end">${h.total_cost ? formatCurrency(h.total_cost) : '-'}</td>
                    <td class="text-end">${formatValueInJPY(h.current_value, h.currency)}</td>
                    <td class="text-end ${pnlClass}">
                        ${unrealizedPnL !== null ? formatCurrency(unrealizedPnL) : '-'}
                    </td>
                    <td class="text-end ${pnlClass}">
                        ${unrealizedPnLPct !== null ? formatPercentage(unrealizedPnLPct) : '-'}
                    </td>
                    <td class="text-end ${irrClass}">
                        ${h.irr !== null ? formatPercentage(h.irr) : '-'}
                    </td>
                    <td class="text-end ${h.day_change_pct !== null && h.day_change_pct >= 0 ? 'positive' : 'negative'}">
                        ${h.day_change_pct !== null ? formatPercentage(h.day_change_pct) : '-'}
                    </td>
                </tr>
            `;
        }).join('');

        // Calculate and display totals (フィルタリングされたデータを使用)
        const totalCost = filteredData.reduce((sum, h) => sum + (parseFloat(h.total_cost) || 0), 0);
        const totalValue = filteredData.reduce((sum, h) => {
            const valueJPY = h.current_value;
            return sum + (valueJPY !== null && !isNaN(valueJPY) ? parseFloat(valueJPY) : 0);
        }, 0);
        const totalPnL = filteredData.reduce((sum, h) => {
            const pnl = h.unrealized_pnl;
            return sum + (pnl !== null && !isNaN(pnl) ? parseFloat(pnl) : 0);
        }, 0);

        document.getElementById('total-cost').innerHTML = `<strong>${formatCurrency(totalCost)}</strong>`;
        document.getElementById('total-value').innerHTML = `<strong>${formatCurrency(totalValue)}</strong>`;

        const pnlClass = totalPnL >= 0 ? 'positive' : 'negative';
        document.getElementById('holdings-total-pnl').innerHTML = `<strong class="${pnlClass}">${formatCurrency(totalPnL)}</strong>`;
        document.getElementById('holdings-total-pnl').className = `text-end ${pnlClass}`;

        // Calculate and display total P&L percentage
        const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
        document.getElementById('holdings-total-pnl-pct').innerHTML = `<strong class="${pnlClass}">${formatPercentage(totalPnLPct)}</strong>`;
        document.getElementById('holdings-total-pnl-pct').className = `text-end ${pnlClass}`;

        // Display IRR (average of filtered holdings with valid IRR)
        const validIrrs = filteredData.filter(h => h.irr !== null).map(h => h.irr);
        if (validIrrs.length > 0) {
            const avgIrr = validIrrs.reduce((sum, irr) => sum + irr, 0) / validIrrs.length;
            const irrClass = avgIrr >= 0 ? 'positive' : 'negative';
            document.getElementById('holdings-total-irr').innerHTML = `<strong class="${irrClass}">${formatPercentage(avgIrr)}</strong>`;
            document.getElementById('holdings-total-irr').className = `text-end ${irrClass}`;
        } else {
            document.getElementById('holdings-total-irr').innerHTML = `<strong>-</strong>`;
        }

        // Calculate and display total day change percentage (フィルタリングされたデータを使用)
        let totalYesterdayValue = 0;
        filteredData.forEach(h => {
            const currentValJPY = h.current_value;
            if (currentValJPY !== null && !isNaN(currentValJPY)) {
                const dayChangePct = parseFloat(h.day_change_pct) || 0;
                const yesterdayValJPY = currentValJPY / (1 + dayChangePct / 100);
                totalYesterdayValue += yesterdayValJPY;
            }
        });

        const totalDayChangePct = totalYesterdayValue > 0 ? ((totalValue / totalYesterdayValue) - 1) * 100 : 0;
        const dayChangeClass = totalDayChangePct >= 0 ? 'positive' : 'negative';
        document.getElementById('holdings-total-day-change').innerHTML = `<strong class="${dayChangeClass}">${formatPercentage(totalDayChangePct)}</strong>`;
        document.getElementById('holdings-total-day-change').className = `text-end ${dayChangeClass}`;

        document.getElementById('holdings-tfoot').classList.remove('d-none');
    }

    // テーブルの並べ替え
    function sortTable(field) {
        if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortDirection = 'asc';
        }

        holdingsData.sort((a, b) => {
            let aValue, bValue;

            // For calculated fields, use the pre-calculated JPY values
            if (field === 'unrealized_pnl') {
                aValue = a.calculated_unrealized_pnl;
                bValue = b.calculated_unrealized_pnl;
            } else if (field === 'unrealized_pnl_pct') {
                aValue = a.calculated_unrealized_pnl_pct;
                bValue = b.calculated_unrealized_pnl_pct;
            } else if (field === 'current_value') {
                aValue = a.current_value;
                bValue = b.current_value;
            } else if (field === 'total_cost') {
                // total_cost is already in JPY
                aValue = a.total_cost;
                bValue = b.total_cost;
            } else if (field === 'irr') {
                aValue = a.irr;
                bValue = b.irr;
            } else if (field === 'day_change_pct') {
                aValue = a.day_change_pct;
                bValue = b.day_change_pct;
            } else {
                aValue = a[field];
                bValue = b[field];
            }

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (typeof aValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            let comparison = 0;
            if (aValue > bValue) {
                comparison = 1;
            } else if (aValue < bValue) {
                comparison = -1;
            }

            return currentSortDirection === 'asc' ? comparison : -comparison;
        });

        renderHoldingsTable();
        updateSortIndicators();
    }

    // ソートインジケーターを更新
    function updateSortIndicators() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });

        if (currentSortField) {
            const fieldMap = {
                'ticker_symbol': 0,
                'security_name': 1,
                'total_cost': 5,
                'current_value': 6,
                'unrealized_pnl': 7,
                'unrealized_pnl_pct': 8,
                'irr': 9,
                'day_change_pct': 10
            };
            const index = fieldMap[currentSortField];
            if (index !== undefined) {
                const headers = document.querySelectorAll('#holdings-table thead th');
                headers[index].classList.add(currentSortDirection);
            }
        }
    }

    // データを更新
    async function refreshData() {
        try {
            const response = await fetch('/api/stock-price/update-all', { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                await loadData();
                metricsData = []; // 評価指標キャッシュクリア
                alert('データを更新しました');
            }
        } catch (error) {
            console.error('データ更新エラー:', error);
            alert('データの更新に失敗しました');
        }
    }

    // ========== 評価指標関連の関数 ==========

    // 評価指標データを取得
    async function loadMetricsData() {
        console.log('[DEBUG] loadMetricsData 開始');

        // どちらのタブが開かれているか判定
        const activeTabId = document.querySelector('.nav-link.active').id;
        let tbody;
        let colspan;

        if (activeTabId === 'metrics1-tab') {
            tbody = document.getElementById('metrics1-tbody');
            colspan = 10;
        } else if (activeTabId === 'metrics2-tab') {
            tbody = document.getElementById('metrics2-tbody');
            colspan = 9;
        } else {
            // デフォルトで評価指標1
            tbody = document.getElementById('metrics1-tbody');
            colspan = 10;
        }

        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center"><div class="loading">データを読み込み中...</div></td></tr>`;

        try {
            console.log('[DEBUG] APIリクエスト送信: /api/holdings/metrics');
            const response = await fetch('/api/holdings/metrics');
            console.log('[DEBUG] レスポンス受信:', response.status, response.ok);

            const result = await response.json();
            console.log('[DEBUG] JSONパース完了:', result);
            console.log('[DEBUG] success:', result.success);
            console.log('[DEBUG] count:', result.count);
            console.log('[DEBUG] metrics length:', result.metrics ? result.metrics.length : 'undefined');

            if (result.success) {
                metricsData = result.metrics;
                console.log('[DEBUG] metricsData 設定完了:', metricsData.length, '件');

                // 開かれているタブに応じて描画
                if (activeTabId === 'metrics1-tab') {
                    renderMetrics1Table();
                } else if (activeTabId === 'metrics2-tab') {
                    renderMetrics2Table();
                } else {
                    renderMetrics1Table();
                }
            } else {
                console.error('[DEBUG] API成功フラグがfalse');
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger">評価指標の読み込みに失敗しました</td></tr>`;
            }
        } catch (error) {
            console.error('[DEBUG] 評価指標データ取得エラー:', error);
            console.error('[DEBUG] エラー詳細:', error.message, error.stack);
            tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger">評価指標の読み込みに失敗しました: ${error.message}</td></tr>`;
        }
    }

    // 評価指標用のフィルタリング（holdingsDataのティッカーに基づく）
    function getFilteredMetricsData(data) {
        const filteredHoldings = getFilteredData(holdingsData);
        const filteredTickers = filteredHoldings.map(h => h.ticker_symbol);
        return data.filter(m => filteredTickers.includes(m.ticker_symbol));
    }

    // 評価指標1テーブルを描画 (バリュエーション指標)
    function renderMetrics1Table() {
        console.log('[DEBUG] renderMetrics1Table 開始');
        const tbody = document.getElementById('metrics1-tbody');
        console.log('[DEBUG] tbody要素:', tbody);
        console.log('[DEBUG] metricsData件数:', metricsData.length);

        // フィルタリング
        const filteredMetrics = getFilteredMetricsData(metricsData);

        if (filteredMetrics.length === 0) {
            console.log('[DEBUG] データなし');
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">評価指標データがありません</td></tr>';
            return;
        }

        console.log('[DEBUG] 評価指標1テーブル描画開始');
        try {
            tbody.innerHTML = filteredMetrics.map(m => {
                // holdingsDataから株価情報を取得
                const holding = holdingsData.find(h => h.ticker_symbol === m.ticker_symbol);
                const currentPrice = holding ? holding.current_price : null;
                const currency = holding ? holding.currency : m.currency;

                return `
                <tr>
                    <td><strong>${m.ticker_symbol}</strong></td>
                    <td>${getSecurityName(m.ticker_symbol)}</td>
                    <td class="text-end">${currentPrice ? formatPrice(currentPrice, currency) + ' ' + currency : '-'}</td>
                    <td class="text-end">${formatMarketCap(m.market_cap, currency)}</td>
                    <td class="text-end">${formatDecimal(m.beta, 2)}</td>
                    <td class="text-end">${formatDecimal(m.pe_ratio, 2)}</td>
                    <td class="text-end">${formatDecimal(m.pb_ratio, 2)}</td>
                    <td class="text-end">${formatDecimal(m.eps, 2)}</td>
                    <td class="text-end">${formatDecimal(m.ev_to_revenue, 2)}</td>
                    <td class="text-end">${formatDecimal(m.ev_to_ebitda, 2)}</td>
                </tr>
            `;
            }).join('');
            console.log('[DEBUG] 評価指標1テーブル描画完了');
        } catch (error) {
            console.error('[DEBUG] テーブル描画エラー:', error);
            console.error('[DEBUG] エラー詳細:', error.message, error.stack);
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">テーブルの描画に失敗しました: ' + error.message + '</td></tr>';
        }
    }

    // 評価指標2テーブルを描画 (パフォーマンス指標)
    function renderMetrics2Table() {
        console.log('[DEBUG] renderMetrics2Table 開始');
        const tbody = document.getElementById('metrics2-tbody');
        console.log('[DEBUG] tbody要素:', tbody);
        console.log('[DEBUG] metricsData件数:', metricsData.length);

        // フィルタリング
        const filteredMetrics = getFilteredMetricsData(metricsData);

        if (filteredMetrics.length === 0) {
            console.log('[DEBUG] データなし');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">評価指標データがありません</td></tr>';
            return;
        }

        console.log('[DEBUG] 評価指標2テーブル描画開始');
        try {
            tbody.innerHTML = filteredMetrics.map(m => {
                // holdingsDataから株価と対前日変動率を取得
                const holding = holdingsData.find(h => h.ticker_symbol === m.ticker_symbol);
                const currentPrice = holding ? holding.current_price : null;
                const currency = holding ? holding.currency : m.currency;
                const dayChangePct = holding ? holding.day_change_pct : null;

                return `
                <tr>
                    <td><strong>${m.ticker_symbol}</strong></td>
                    <td>${getSecurityName(m.ticker_symbol)}</td>
                    <td class="text-end">${currentPrice ? formatPrice(currentPrice, currency) + ' ' + currency : '-'}</td>
                    <td class="text-end ${dayChangePct !== null && dayChangePct >= 0 ? 'positive' : 'negative'}">
                        ${dayChangePct !== null ? formatPercentage(dayChangePct) : '-'}
                    </td>
                    <td class="text-end ${getReturnClass(m.ytd_return)}">${formatPercentageMetrics(m.ytd_return)}</td>
                    <td class="text-end ${getReturnClass(m.one_year_return)}">${formatPercentageMetrics(m.one_year_return)}</td>
                    <td>${format52WeekRange(m.fifty_two_week_low, m.fifty_two_week_high, currency)}</td>
                    <td class="text-end">${formatRevenue(m.revenue, currency)}</td>
                    <td class="text-end">${formatPercentageMetrics(m.profit_margin)}</td>
                </tr>
            `;
            }).join('');
            console.log('[DEBUG] 評価指標2テーブル描画完了');
        } catch (error) {
            console.error('[DEBUG] テーブル描画エラー:', error);
            console.error('[DEBUG] エラー詳細:', error.message, error.stack);
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">テーブルの描画に失敗しました: ' + error.message + '</td></tr>';
        }
    }

    // 銘柄名を取得（holdingsDataから）
    function getSecurityName(ticker) {
        const holding = holdingsData.find(h => h.ticker_symbol === ticker);
        return holding ? holding.security_name || '-' : '-';
    }

    // 時価総額フォーマット
    function formatMarketCap(value, currency) {
        if (!value) return '-';
        // すべての通貨で TN (Trillion), BN (Billion), MN (Million) - 小数点なし
        if (value >= 1e12) return (value / 1e12).toFixed(0) + 'TN';
        if (value >= 1e9) return (value / 1e9).toFixed(0) + 'BN';
        if (value >= 1e6) return (value / 1e6).toFixed(0) + 'MN';
        return value.toLocaleString();
    }

    // 小数フォーマット
    function formatDecimal(value, decimals) {
        if (value === null || value === undefined) return '-';
        return Number(value).toFixed(decimals);
    }

    // パーセンテージフォーマット（評価指標用）
    function formatPercentageMetrics(value) {
        if (value === null || value === undefined) return '-';
        const pct = value * 100;
        // 利益率の場合は+マークを付けない
        return pct.toFixed(2) + '%';
    }

    // 52週レンジフォーマット
    function format52WeekRange(low, high, currency) {
        if (!low || !high) return '-';
        return `${formatDecimal(low, 2)} - ${formatDecimal(high, 2)} ${currency}`;
    }

    // 売上フォーマット
    function formatRevenue(value, currency) {
        if (!value) return '-';
        // すべての通貨で TN (Trillion), BN (Billion), MN (Million) - 小数点なし
        if (value >= 1e12) return (value / 1e12).toFixed(0) + 'TN';
        if (value >= 1e9) return (value / 1e9).toFixed(0) + 'BN';
        if (value >= 1e6) return (value / 1e6).toFixed(0) + 'MN';
        return value.toLocaleString();
    }

    // リターンのクラス（正負で色分け）
    function getReturnClass(value) {
        if (value === null || value === undefined) return '';
        return value >= 0 ? 'positive' : 'negative';
    }

    // フォーマット関数
    function formatCurrency(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 0 });
    }

    function formatPrice(value, currency) {
        if (value === null || value === undefined) return '-';

        let decimals = 0;
        if (currency === 'USD') {
            decimals = 2;
        } else if (currency === 'JPY' || currency === '日本円' || currency === 'KRW') {
            decimals = 0;
        } else {
            decimals = 2;
        }

        return Number(value).toLocaleString('ja-JP', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatAverageCost(holding) {
        if (!holding.average_cost) return '-';

        // Holding.average_cost is always in JPY (Calculated from settlement amount)
        // Main display: JPY
        let result = `${formatCurrency(holding.average_cost)} JPY`;

        // Sub display: Foreign Currency
        const currency = holding.currency ? holding.currency.toUpperCase() : 'JPY';

        if (currency !== 'JPY' && currency !== '日本円') {
            // Try to find rate with normalized key
            let rateData = exchangeRates[currency];

            // If not found, try to look for keys case-insensitively
            if (!rateData) {
                const key = Object.keys(exchangeRates).find(k => k.toUpperCase() === currency);
                if (key) rateData = exchangeRates[key];
            }

            const rate = rateData?.rate;

            if (rate && rate > 0) {
                // Convert JPY back to Foreign Currency
                const foreignAmount = holding.average_cost / rate;
                const formattedForeign = formatPrice(foreignAmount, currency);

                // Display foreign amount in parentheses
                result += `<br><small style="color: #6c757d;">(${formattedForeign} ${currency})</small>`;
            } else {
                console.warn(`Rate not available for ${currency}`, exchangeRates);
                // Rate not available
                result += `<br><small style="color: #6c757d;">(Rate N/A)</small>`;
            }
        }

        return result;
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 4 });
    }

    function formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        const sign = value >= 0 ? '+' : '';
        return sign + Number(value).toFixed(2) + '%';
    }

    // 評価指標1テーブルのソート
    function sortMetrics1Table(field) {
        if (metrics1SortField === field) {
            metrics1SortDirection = metrics1SortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            metrics1SortField = field;
            metrics1SortDirection = 'asc';
        }

        metricsData.sort((a, b) => {
            let aValue, bValue;

            // holdingsDataから株価等を取得
            const aHolding = holdingsData.find(h => h.ticker_symbol === a.ticker_symbol);
            const bHolding = holdingsData.find(h => h.ticker_symbol === b.ticker_symbol);

            if (field === 'ticker_symbol') {
                aValue = a.ticker_symbol;
                bValue = b.ticker_symbol;
            } else if (field === 'security_name') {
                aValue = getSecurityName(a.ticker_symbol);
                bValue = getSecurityName(b.ticker_symbol);
            } else if (field === 'current_price') {
                aValue = aHolding ? aHolding.current_price : null;
                bValue = bHolding ? bHolding.current_price : null;
            } else {
                aValue = a[field];
                bValue = b[field];
            }

            // null/undefinedを最後に配置
            const aIsNull = aValue === null || aValue === undefined;
            const bIsNull = bValue === null || bValue === undefined;
            if (aIsNull && bIsNull) return 0;
            if (aIsNull) return 1;
            if (bIsNull) return -1;

            // 文字列の場合は小文字で比較
            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            let comparison = 0;
            if (aValue > bValue) comparison = 1;
            else if (aValue < bValue) comparison = -1;

            return metrics1SortDirection === 'asc' ? comparison : -comparison;
        });

        renderMetrics1Table();
        updateMetrics1SortIndicators();
    }

    // 評価指標1ソートインジケーター更新
    function updateMetrics1SortIndicators() {
        document.querySelectorAll('#metrics1-table .sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });

        if (metrics1SortField) {
            const fieldMap = {
                'ticker_symbol': 0,
                'security_name': 1,
                'current_price': 2,
                'market_cap': 3,
                'beta': 4,
                'pe_ratio': 5,
                'pb_ratio': 6,
                'eps': 7,
                'ev_to_revenue': 8,
                'ev_to_ebitda': 9
            };
            const index = fieldMap[metrics1SortField];
            if (index !== undefined) {
                const headers = document.querySelectorAll('#metrics1-table thead th');
                headers[index].classList.add(metrics1SortDirection);
            }
        }
    }

    // 評価指標2テーブルのソート
    function sortMetrics2Table(field) {
        if (metrics2SortField === field) {
            metrics2SortDirection = metrics2SortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            metrics2SortField = field;
            metrics2SortDirection = 'asc';
        }

        metricsData.sort((a, b) => {
            let aValue, bValue;

            // holdingsDataから株価等を取得
            const aHolding = holdingsData.find(h => h.ticker_symbol === a.ticker_symbol);
            const bHolding = holdingsData.find(h => h.ticker_symbol === b.ticker_symbol);

            if (field === 'ticker_symbol') {
                aValue = a.ticker_symbol;
                bValue = b.ticker_symbol;
            } else if (field === 'security_name') {
                aValue = getSecurityName(a.ticker_symbol);
                bValue = getSecurityName(b.ticker_symbol);
            } else if (field === 'current_price') {
                aValue = aHolding ? aHolding.current_price : null;
                bValue = bHolding ? bHolding.current_price : null;
            } else if (field === 'day_change_pct') {
                aValue = aHolding ? aHolding.day_change_pct : null;
                bValue = bHolding ? bHolding.day_change_pct : null;
            } else {
                aValue = a[field];
                bValue = b[field];
            }

            // null/undefinedを最後に配置
            const aIsNull = aValue === null || aValue === undefined;
            const bIsNull = bValue === null || bValue === undefined;
            if (aIsNull && bIsNull) return 0;
            if (aIsNull) return 1;
            if (bIsNull) return -1;

            // 文字列の場合は小文字で比較
            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            let comparison = 0;
            if (aValue > bValue) comparison = 1;
            else if (aValue < bValue) comparison = -1;

            return metrics2SortDirection === 'asc' ? comparison : -comparison;
        });

        renderMetrics2Table();
        updateMetrics2SortIndicators();
    }

    // 評価指標2ソートインジケーター更新
    function updateMetrics2SortIndicators() {
        document.querySelectorAll('#metrics2-table .sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });

        if (metrics2SortField) {
            const fieldMap = {
                'ticker_symbol': 0,
                'security_name': 1,
                'current_price': 2,
                'day_change_pct': 3,
                'ytd_return': 4,
                'one_year_return': 5,
                'revenue': 7,
                'profit_margin': 8
            };
            const index = fieldMap[metrics2SortField];
            if (index !== undefined) {
                const headers = document.querySelectorAll('#metrics2-table thead th');
                headers[index].classList.add(metrics2SortDirection);
            }
        }
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}保有銘柄一覧 - Stock P&L Manager{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-top: 20px;
    }
    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    #holdings-tfoot tr {
        border-top: 2px solid #dee2e6;
        font-weight: bold;
    }
    #holdings-tfoot td {
        padding: 12px 8px;
    }
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }
    .sortable:hover {
        background-color: #f8f9fa;
    }
    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }
    .sortable.asc::after {
        content: '▲';
        opacity: 1;
    }
    .sortable.desc::after {
        content: '▼';
        opacity: 1;
    }
    .positive {
        color: #28a745;
    }
    .negative {
        color: #dc3545;
    }
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="holdings-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>保有銘柄一覧</h1>
        <button class="btn btn-primary" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise"></i> データを更新
        </button>
    </div>

    <!-- 保有銘柄テーブル -->
    <div class="table-container">
        <!-- 為替レート表示 -->
        <div class="alert alert-info mb-3" id="exchange-rates-display" style="display: none;">
            <strong>換算為替レート:</strong>
            <span id="exchange-rates-text">読み込み中...</span>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="holdings-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('ticker_symbol')">ティッカー</th>
                        <th class="sortable" onclick="sortTable('security_name')">銘柄名</th>
                        <th class="text-end">保有数量</th>
                        <th class="text-end">平均取得単価</th>
                        <th class="text-end">現在株価</th>
                        <th class="sortable text-end" onclick="sortTable('total_cost')">取得コスト</th>
                        <th class="sortable text-end" onclick="sortTable('current_value')">評価額</th>
                        <th class="sortable text-end" onclick="sortTable('unrealized_pnl')">未実現損益</th>
                        <th class="sortable text-end" onclick="sortTable('unrealized_pnl_pct')">損益率</th>
                        <th class="sortable text-end" onclick="sortTable('day_change_pct')">対前日変動率</th>
                    </tr>
                </thead>
                <tbody id="holdings-tbody">
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="loading">データを読み込み中...</div>
                        </td>
                    </tr>
                </tbody>
                <tfoot id="holdings-tfoot" class="table-light d-none">
                    <tr>
                        <td colspan="5" class="text-end"><strong>合計</strong></td>
                        <td class="text-end" id="total-cost"><strong>-</strong></td>
                        <td class="text-end" id="total-value"><strong>-</strong></td>
                        <td class="text-end" id="holdings-total-pnl"><strong>-</strong></td>
                        <td class="text-end" id="holdings-total-pnl-pct"><strong>-</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let holdingsData = [];
    let currentSortField = null;
    let currentSortDirection = 'asc';
    let exchangeRates = {};

    // ページ読み込み時にデータ取得
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
    });

    // データの読み込み
    async function loadData() {
        await loadExchangeRates();
        await loadHoldingsTable();
    }

    // 為替レートの読み込み
    async function loadExchangeRates() {
        try {
            const response = await fetch('/api/exchange-rate/multiple?currencies=USD,KRW');
            const result = await response.json();

            if (result.success) {
                exchangeRates = result.rates;
                displayExchangeRates();
            }
        } catch (error) {
            console.error('為替レートの読み込みエラー:', error);
        }
    }

    // 為替レートの表示
    function displayExchangeRates() {
        const display = document.getElementById('exchange-rates-display');
        const text = document.getElementById('exchange-rates-text');

        const rates = [];
        if (exchangeRates.USD && exchangeRates.USD.rate) {
            rates.push(`USD/JPY: ${exchangeRates.USD.rate.toFixed(2)}`);
        }
        if (exchangeRates.KRW && exchangeRates.KRW.rate) {
            rates.push(`KRW/JPY: ${exchangeRates.KRW.rate.toFixed(4)}`);
        }

        if (rates.length > 0) {
            text.textContent = rates.join(' | ');
            display.style.display = 'block';
        }
    }

    // 保有銘柄テーブルの読み込み
    async function loadHoldingsTable() {
        try {
            const response = await fetch('/api/holdings');
            const result = await response.json();

            if (result.success) {
                holdingsData = result.holdings.map(h => ({
                    ...h,
                    calculated_unrealized_pnl: calculateUnrealizedPnL(h),
                    calculated_unrealized_pnl_pct: calculateUnrealizedPnLPct(h)
                }));
                renderHoldingsTable();
            }
        } catch (error) {
            console.error('保有銘柄データの読み込みエラー:', error);
            document.getElementById('holdings-tbody').innerHTML = '<tr><td colspan="10" class="text-center text-danger">データの読み込みに失敗しました</td></tr>';
        }
    }

    // 通貨をJPYに換算
    function convertToJPY(amount, currency) {
        if (amount === null || amount === undefined) return null;

        const numAmount = parseFloat(amount);
        if (isNaN(numAmount)) return null;

        if (currency === 'JPY' || currency === '日本円') return numAmount;

        const rate = exchangeRates[currency]?.rate;
        if (!rate) return numAmount;

        return numAmount * rate;
    }

    // 株価を表示用にフォーマット（現在株価 + JPY換算 + 前日終値）
    function formatPriceWithPreviousClose(currentPrice, previousClose, currency) {
        if (!currentPrice) return '-';

        const priceStr = formatPrice(currentPrice, currency);
        let result = priceStr;

        // Add currency for foreign stocks
        if (currency !== 'JPY' && currency !== '日本円') {
            result += ` ${currency}`;

            // Add JPY conversion
            const jpyAmount = convertToJPY(currentPrice, currency);
            if (jpyAmount && jpyAmount !== currentPrice) {
                result += `<br><small>(${formatCurrency(jpyAmount)} JPY)</small>`;
            }
        }

        // Add previous close
        if (previousClose !== null && previousClose !== undefined) {
            result += `<br><small style="color: #6c757d;">(前日: ${formatPrice(previousClose, currency)})</small>`;
        }

        return result;
    }

    // 評価額を表示用にフォーマット（JPYのみ）
    function formatValueInJPY(value, currency) {
        if (!value) return '-';

        const jpyAmount = convertToJPY(value, currency);
        return formatCurrency(jpyAmount);
    }

    // 未実現損益を計算（評価額(JPY) - 取得コスト）
    function calculateUnrealizedPnL(holding) {
        if (holding.current_value === null || holding.current_value === undefined ||
            holding.total_cost === null || holding.total_cost === undefined) {
            return null;
        }

        const currentValueJPY = convertToJPY(holding.current_value, holding.currency);
        if (currentValueJPY === null) return null;

        const totalCost = parseFloat(holding.total_cost);
        if (isNaN(totalCost)) return null;

        return currentValueJPY - totalCost;
    }

    // 未実現損益率を計算
    function calculateUnrealizedPnLPct(holding) {
        const pnl = calculateUnrealizedPnL(holding);
        if (pnl === null || !holding.total_cost) return null;

        const totalCost = parseFloat(holding.total_cost);
        if (totalCost === 0) return null;

        return (pnl / totalCost) * 100;
    }

    function renderHoldingsTable() {
        const tbody = document.getElementById('holdings-tbody');

        if (holdingsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">保有銘柄がありません</td></tr>';
            document.getElementById('holdings-tfoot').classList.add('d-none');
            return;
        }

        tbody.innerHTML = holdingsData.map(h => {
            const unrealizedPnL = calculateUnrealizedPnL(h);
            const unrealizedPnLPct = calculateUnrealizedPnLPct(h);
            const pnlClass = unrealizedPnL !== null && unrealizedPnL >= 0 ? 'positive' : 'negative';

            return `
                <tr>
                    <td><strong>${h.ticker_symbol}</strong></td>
                    <td>${h.security_name || '-'}</td>
                    <td class="text-end">${formatNumber(h.total_quantity)}</td>
                    <td class="text-end">${formatAverageCost(h)}</td>
                    <td class="text-end">${formatPriceWithPreviousClose(h.current_price, h.previous_close, h.currency)}</td>
                    <td class="text-end">${h.total_cost ? formatCurrency(h.total_cost) : '-'}</td>
                    <td class="text-end">${formatValueInJPY(h.current_value, h.currency)}</td>
                    <td class="text-end ${pnlClass}">
                        ${unrealizedPnL !== null ? formatCurrency(unrealizedPnL) : '-'}
                    </td>
                    <td class="text-end ${pnlClass}">
                        ${unrealizedPnLPct !== null ? formatPercentage(unrealizedPnLPct) : '-'}
                    </td>
                    <td class="text-end ${h.day_change_pct !== null && h.day_change_pct >= 0 ? 'positive' : 'negative'}">
                        ${h.day_change_pct !== null ? formatPercentage(h.day_change_pct) : '-'}
                    </td>
                </tr>
            `;
        }).join('');

        // Calculate and display totals
        const totalCost = holdingsData.reduce((sum, h) => sum + (parseFloat(h.total_cost) || 0), 0);
        const totalValue = holdingsData.reduce((sum, h) => {
            const valueJPY = convertToJPY(h.current_value, h.currency);
            return sum + (valueJPY !== null && !isNaN(valueJPY) ? valueJPY : 0);
        }, 0);
        const totalPnL = holdingsData.reduce((sum, h) => {
            const pnl = calculateUnrealizedPnL(h);
            return sum + (pnl !== null && !isNaN(pnl) ? pnl : 0);
        }, 0);

        document.getElementById('total-cost').innerHTML = `<strong>${formatCurrency(totalCost)}</strong>`;
        document.getElementById('total-value').innerHTML = `<strong>${formatCurrency(totalValue)}</strong>`;

        const pnlClass = totalPnL >= 0 ? 'positive' : 'negative';
        document.getElementById('holdings-total-pnl').innerHTML = `<strong class="${pnlClass}">${formatCurrency(totalPnL)}</strong>`;
        document.getElementById('holdings-total-pnl').className = `text-end ${pnlClass}`;

        // Calculate and display total P&L percentage
        const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
        document.getElementById('holdings-total-pnl-pct').innerHTML = `<strong class="${pnlClass}">${formatPercentage(totalPnLPct)}</strong>`;
        document.getElementById('holdings-total-pnl-pct').className = `text-end ${pnlClass}`;

        document.getElementById('holdings-tfoot').classList.remove('d-none');
    }

    // テーブルの並べ替え
    function sortTable(field) {
        if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortDirection = 'asc';
        }

        holdingsData.sort((a, b) => {
            let fieldName = field;
            if (field === 'unrealized_pnl') {
                fieldName = 'calculated_unrealized_pnl';
            } else if (field === 'unrealized_pnl_pct') {
                fieldName = 'calculated_unrealized_pnl_pct';
            }

            let aValue = a[fieldName];
            let bValue = b[fieldName];

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (typeof aValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            let comparison = 0;
            if (aValue > bValue) {
                comparison = 1;
            } else if (aValue < bValue) {
                comparison = -1;
            }

            return currentSortDirection === 'asc' ? comparison : -comparison;
        });

        renderHoldingsTable();
        updateSortIndicators();
    }

    // ソートインジケーターを更新
    function updateSortIndicators() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });

        if (currentSortField) {
            const fieldMap = {
                'ticker_symbol': 0,
                'security_name': 1,
                'total_cost': 5,
                'current_value': 6,
                'unrealized_pnl': 7,
                'unrealized_pnl_pct': 8,
                'day_change_pct': 9
            };
            const index = fieldMap[currentSortField];
            if (index !== undefined) {
                const headers = document.querySelectorAll('#holdings-table thead th');
                headers[index].classList.add(currentSortDirection);
            }
        }
    }

    // データを更新
    async function refreshData() {
        try {
            const response = await fetch('/api/stock-price/update-all', { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                await loadData();
                alert('データを更新しました');
            }
        } catch (error) {
            console.error('データ更新エラー:', error);
            alert('データの更新に失敗しました');
        }
    }

    // フォーマット関数
    function formatCurrency(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 0 });
    }

    function formatPrice(value, currency) {
        if (value === null || value === undefined) return '-';

        let decimals = 0;
        if (currency === 'USD') {
            decimals = 2;
        } else if (currency === 'JPY' || currency === '日本円' || currency === 'KRW') {
            decimals = 0;
        } else {
            decimals = 2;
        }

        return Number(value).toLocaleString('ja-JP', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatAverageCost(holding) {
        if (!holding.average_cost) return '-';

        const avgCost = formatPrice(holding.average_cost, holding.currency);
        let result = `${avgCost} ${holding.currency}`;

        if (holding.currency !== 'JPY' && holding.currency !== '日本円') {
            if (holding.total_cost && holding.total_quantity) {
                const jpyPerShare = holding.total_cost / holding.total_quantity;
                result += `<br><small style="color: #6c757d;">(実質: ${formatCurrency(jpyPerShare)}円)</small>`;
            }
        }

        return result;
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 4 });
    }

    function formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        const sign = value >= 0 ? '+' : '';
        return sign + Number(value).toFixed(2) + '%';
    }
</script>
{% endblock %}

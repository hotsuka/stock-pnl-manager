{% extends "base.html" %}

{% block title %}保有銘柄一覧 - Stock P&L Manager{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-top: 20px;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    #holdings-tfoot tr {
        border-top: 2px solid #dee2e6;
        font-weight: bold;
    }

    #holdings-tfoot td {
        padding: 12px 8px;
    }

    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }

    .sortable:hover {
        background-color: #f8f9fa;
    }

    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }

    .sortable.asc::after {
        content: '▲';
        opacity: 1;
    }

    .sortable.desc::after {
        content: '▼';
        opacity: 1;
    }

    .positive {
        color: #28a745;
    }

    .negative {
        color: #dc3545;
    }

    /* Sticky Header 修正版 */
    .table-responsive {
        overflow: visible !important;
        /* ウィンドウスクロールでの sticky を有効化 */
    }

    #holdings-table thead th {
        position: sticky;
        top: 56px;
        /* ナビゲーションバーの高さ (Bootstrap default 56px) に調整 */
        background-color: #fff !important;
        /* 背景色を強制（不透明化） */
        z-index: 1020;
        /* ナビゲーションバー(1030)より下、他要素より上 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        /* 下部に影をつけて境界を明示 */
        border-bottom: 2px solid #dee2e6;
    }

    /* ソート可能なヘッダーのホバー色も sticky 維持のため調整 */
    #holdings-table thead th.sortable:hover {
        background-color: #f8f9fa !important;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="holdings-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>保有銘柄一覧</h1>
        <button class="btn btn-primary" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise"></i> データを更新
        </button>
    </div>

    <!-- タブナビゲーション -->
    <ul class="nav nav-tabs mb-3" id="holdingsTabs">
        <li class="nav-item">
            <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab"
                    data-bs-target="#basic-info">基本情報</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="metrics-tab" data-bs-toggle="tab"
                    data-bs-target="#metrics">評価指標</button>
        </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content">
        <!-- 基本情報タブ -->
        <div class="tab-pane fade show active" id="basic-info">
            <div class="table-container">
                <!-- 為替レート表示 -->
                <div class="alert alert-info mb-3" id="exchange-rates-display" style="display: none;">
                    <strong>換算為替レート:</strong>
                    <span id="exchange-rates-text">読み込み中...</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="holdings-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('ticker_symbol')">ティッカー</th>
                                <th class="sortable" onclick="sortTable('security_name')">銘柄名</th>
                                <th class="text-end">保有数量</th>
                                <th class="text-end">平均取得単価</th>
                                <th class="text-end">現在株価</th>
                                <th class="sortable text-end" onclick="sortTable('total_cost')">取得コスト</th>
                                <th class="sortable text-end" onclick="sortTable('current_value')">評価額</th>
                                <th class="sortable text-end" onclick="sortTable('unrealized_pnl')">未実現損益</th>
                                <th class="sortable text-end" onclick="sortTable('unrealized_pnl_pct')">損益率</th>
                                <th class="sortable text-end" onclick="sortTable('day_change_pct')">対前日変動率</th>
                            </tr>
                        </thead>
                        <tbody id="holdings-tbody">
                            <tr>
                                <td colspan="10" class="text-center">
                                    <div class="loading">データを読み込み中...</div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot id="holdings-tfoot" class="table-light d-none">
                            <tr>
                                <td colspan="5" class="text-end"><strong>合計</strong></td>
                                <td class="text-end" id="total-cost"><strong>-</strong></td>
                                <td class="text-end" id="total-value"><strong>-</strong></td>
                                <td class="text-end" id="holdings-total-pnl"><strong>-</strong></td>
                                <td class="text-end" id="holdings-total-pnl-pct"><strong>-</strong></td>
                                <td class="text-end" id="holdings-total-day-change"><strong>-</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- 評価指標タブ -->
        <div class="tab-pane fade" id="metrics">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover" id="metrics-table">
                        <thead>
                            <tr>
                                <th>ティッカー</th>
                                <th>銘柄名</th>
                                <th class="text-end">時価総額</th>
                                <th class="text-end">Beta</th>
                                <th class="text-end">PER</th>
                                <th class="text-end">EPS</th>
                                <th>52週レンジ</th>
                                <th class="text-end">YTDリターン</th>
                                <th class="text-end">1年リターン</th>
                                <th class="text-end">PBR</th>
                                <th class="text-end">EV/売上</th>
                                <th class="text-end">EV/EBITDA</th>
                                <th class="text-end">売上</th>
                                <th class="text-end">利益率</th>
                            </tr>
                        </thead>
                        <tbody id="metrics-tbody">
                            <tr>
                                <td colspan="14" class="text-center">
                                    <div class="loading">評価指標タブを選択すると、データが読み込まれます</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let holdingsData = [];
    let metricsData = [];
    let currentSortField = null;
    let currentSortDirection = 'asc';
    let exchangeRates = {};

    // ページ読み込み時にデータ取得
    document.addEventListener('DOMContentLoaded', function () {
        loadData();

        // タブ切替イベント
        document.getElementById('metrics-tab').addEventListener('shown.bs.tab', function() {
            if (metricsData.length === 0) {
                loadMetricsData();
            }
        });
    });

    // ティッカーから通貨を推測するヘルパー関数
    function inferCurrency(ticker, dbCurrency) {
        // 日本株（.Tで終わる）
        if (ticker.endsWith('.T')) return 'JPY';
        // 韓国株（.KSで終わる）
        if (ticker.endsWith('.KS')) return 'KRW';
        // 上記以外で、DBの通貨がJPYの場合は米国株と推測
        if (dbCurrency === 'JPY' && !ticker.includes('.')) return 'USD';
        // その他はDBの値を使用
        return dbCurrency;
    }

    // データの読み込み
    async function loadData() {
        // 1. まず保有銘柄データを取得
        await fetchHoldingsData();

        // 2. 保有銘柄の通貨リストを抽出して為替レートを取得
        if (holdingsData.length > 0) {
            const currencies = [...new Set(holdingsData.map(h => h.currency))].filter(c => c !== 'JPY' && c !== '日本円');
            if (currencies.length > 0) {
                await loadExchangeRates(currencies);
            }

            // 3. 為替レート取得後に損益を再計算（JPY換算のため）
            holdingsData = holdingsData.map(h => ({
                ...h,
                calculated_unrealized_pnl: calculateUnrealizedPnL(h),
                calculated_unrealized_pnl_pct: calculateUnrealizedPnLPct(h)
            }));
        }

        // 4. テーブル描画
        renderHoldingsTable();
    }

    // 保有銘柄データの取得（描画はしない）
    async function fetchHoldingsData() {
        try {
            const response = await fetch('/api/holdings');
            const result = await response.json();

            if (result.success) {
                holdingsData = result.holdings.map(h => {
                    // ティッカーから正しい通貨を推測
                    const correctedCurrency = inferCurrency(h.ticker_symbol, h.currency);
                    const correctedHolding = {
                        ...h,
                        currency: correctedCurrency
                    };
                    return {
                        ...correctedHolding,
                        calculated_unrealized_pnl: calculateUnrealizedPnL(correctedHolding),
                        calculated_unrealized_pnl_pct: calculateUnrealizedPnLPct(correctedHolding)
                    };
                });
            }
        } catch (error) {
            console.error('保有銘柄データの読み込みエラー:', error);
            document.getElementById('holdings-tbody').innerHTML = '<tr><td colspan="10" class="text-center text-danger">データの読み込みに失敗しました</td></tr>';
        }
    }

    // 為替レートの読み込み
    async function loadExchangeRates(currencies = ['USD', 'KRW']) {
        try {
            const currencyStr = currencies.join(',');
            const response = await fetch(`/api/exchange-rate/multiple?currencies=${currencyStr}`);
            const result = await response.json();

            if (result.success) {
                exchangeRates = result.rates;
                displayExchangeRates();
            }
        } catch (error) {
            console.error('為替レートの読み込みエラー:', error);
        }
    }

    // 為替レートの表示
    function displayExchangeRates() {
        const display = document.getElementById('exchange-rates-display');
        const text = document.getElementById('exchange-rates-text');

        const rates = [];

        // Dynamic rates display
        if (exchangeRates) {
            Object.keys(exchangeRates).forEach(currentKey => {
                if (exchangeRates[currentKey] && exchangeRates[currentKey].rate) {
                    rates.push(`${currentKey}/JPY: ${exchangeRates[currentKey].rate.toFixed(2)}`);
                }
            });
        }

        if (rates.length > 0) {
            text.textContent = rates.join(' | ');
            display.style.display = 'block';
        }
    }

    // 通貨をJPYに換算
    function convertToJPY(amount, currency) {
        if (amount === null || amount === undefined) return null;

        const numAmount = parseFloat(amount);
        if (isNaN(numAmount)) return null;

        if (currency === 'JPY' || currency === '日本円') return numAmount;

        const rate = exchangeRates[currency]?.rate;
        if (!rate) return numAmount;

        return numAmount * rate;
    }

    // 株価を表示用にフォーマット（現在株価 + JPY換算 + 前日終値）
    function formatPriceWithPreviousClose(currentPrice, previousClose, currency) {
        if (!currentPrice) return '-';

        const priceStr = formatPrice(currentPrice, currency);
        let result = priceStr;

        // Add currency for foreign stocks
        if (currency !== 'JPY' && currency !== '日本円') {
            result += ` ${currency}`;

            // Add JPY conversion
            const jpyAmount = convertToJPY(currentPrice, currency);
            if (jpyAmount && jpyAmount !== currentPrice) {
                result += `<br><small>(${formatCurrency(jpyAmount)} JPY)</small>`;
            }
        }

        // Add previous close
        if (previousClose !== null && previousClose !== undefined) {
            result += `<br><small style="color: #6c757d;">(前日: ${formatPrice(previousClose, currency)})</small>`;
        }

        return result;
    }

    // 評価額を表示用にフォーマット（常にJPY）
    function formatValueInJPY(value, currency) {
        if (value === null || value === undefined) return '-';
        return formatCurrency(value); // Already JPY from DB
    }

    // 未実現損益率を計算（DBの値を信頼）
    function calculateUnrealizedPnL(holding) {
        return holding.unrealized_pnl !== null ? parseFloat(holding.unrealized_pnl) : null;
    }

    function calculateUnrealizedPnLPct(holding) {
        return holding.unrealized_pnl_pct !== null ? parseFloat(holding.unrealized_pnl_pct) : null;
    }

    function renderHoldingsTable() {
        const tbody = document.getElementById('holdings-tbody');

        if (holdingsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">保有銘柄がありません</td></tr>';
            document.getElementById('holdings-tfoot').classList.add('d-none');
            return;
        }

        tbody.innerHTML = holdingsData.map(h => {
            const unrealizedPnL = calculateUnrealizedPnL(h);
            const unrealizedPnLPct = calculateUnrealizedPnLPct(h);
            const pnlClass = unrealizedPnL !== null && unrealizedPnL >= 0 ? 'positive' : 'negative';

            return `
                <tr>
                    <td><strong>${h.ticker_symbol}</strong></td>
                    <td>${h.security_name || '-'}</td>
                    <td class="text-end">${formatNumber(h.total_quantity)}</td>
                    <td class="text-end">${formatAverageCost(h)}</td>
                    <td class="text-end">${formatPriceWithPreviousClose(h.current_price, h.previous_close, h.currency)}</td>
                    <td class="text-end">${h.total_cost ? formatCurrency(h.total_cost) : '-'}</td>
                    <td class="text-end">${formatValueInJPY(h.current_value, h.currency)}</td>
                    <td class="text-end ${pnlClass}">
                        ${unrealizedPnL !== null ? formatCurrency(unrealizedPnL) : '-'}
                    </td>
                    <td class="text-end ${pnlClass}">
                        ${unrealizedPnLPct !== null ? formatPercentage(unrealizedPnLPct) : '-'}
                    </td>
                    <td class="text-end ${h.day_change_pct !== null && h.day_change_pct >= 0 ? 'positive' : 'negative'}">
                        ${h.day_change_pct !== null ? formatPercentage(h.day_change_pct) : '-'}
                    </td>
                </tr>
            `;
        }).join('');

        // Calculate and display totals
        const totalCost = holdingsData.reduce((sum, h) => sum + (parseFloat(h.total_cost) || 0), 0);
        const totalValue = holdingsData.reduce((sum, h) => {
            const valueJPY = h.current_value;
            return sum + (valueJPY !== null && !isNaN(valueJPY) ? parseFloat(valueJPY) : 0);
        }, 0);
        const totalPnL = holdingsData.reduce((sum, h) => {
            const pnl = h.unrealized_pnl;
            return sum + (pnl !== null && !isNaN(pnl) ? parseFloat(pnl) : 0);
        }, 0);

        document.getElementById('total-cost').innerHTML = `<strong>${formatCurrency(totalCost)}</strong>`;
        document.getElementById('total-value').innerHTML = `<strong>${formatCurrency(totalValue)}</strong>`;

        const pnlClass = totalPnL >= 0 ? 'positive' : 'negative';
        document.getElementById('holdings-total-pnl').innerHTML = `<strong class="${pnlClass}">${formatCurrency(totalPnL)}</strong>`;
        document.getElementById('holdings-total-pnl').className = `text-end ${pnlClass}`;

        // Calculate and display total P&L percentage
        const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
        document.getElementById('holdings-total-pnl-pct').innerHTML = `<strong class="${pnlClass}">${formatPercentage(totalPnLPct)}</strong>`;
        document.getElementById('holdings-total-pnl-pct').className = `text-end ${pnlClass}`;

        // Calculate and display total day change percentage
        let totalYesterdayValue = 0;
        holdingsData.forEach(h => {
            const currentValJPY = h.current_value;
            if (currentValJPY !== null && !isNaN(currentValJPY)) {
                const dayChangePct = parseFloat(h.day_change_pct) || 0;
                const yesterdayValJPY = currentValJPY / (1 + dayChangePct / 100);
                totalYesterdayValue += yesterdayValJPY;
            }
        });

        const totalDayChangePct = totalYesterdayValue > 0 ? ((totalValue / totalYesterdayValue) - 1) * 100 : 0;
        const dayChangeClass = totalDayChangePct >= 0 ? 'positive' : 'negative';
        document.getElementById('holdings-total-day-change').innerHTML = `<strong class="${dayChangeClass}">${formatPercentage(totalDayChangePct)}</strong>`;
        document.getElementById('holdings-total-day-change').className = `text-end ${dayChangeClass}`;

        document.getElementById('holdings-tfoot').classList.remove('d-none');
    }

    // テーブルの並べ替え
    function sortTable(field) {
        if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortDirection = 'asc';
        }

        holdingsData.sort((a, b) => {
            let aValue, bValue;

            // For calculated fields, use the pre-calculated JPY values
            if (field === 'unrealized_pnl') {
                aValue = a.calculated_unrealized_pnl;
                bValue = b.calculated_unrealized_pnl;
            } else if (field === 'unrealized_pnl_pct') {
                aValue = a.calculated_unrealized_pnl_pct;
                bValue = b.calculated_unrealized_pnl_pct;
            } else if (field === 'current_value') {
                aValue = a.current_value;
                bValue = b.current_value;
            } else if (field === 'total_cost') {
                // total_cost is already in JPY
                aValue = a.total_cost;
                bValue = b.total_cost;
            } else {
                aValue = a[field];
                bValue = b[field];
            }

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (typeof aValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            let comparison = 0;
            if (aValue > bValue) {
                comparison = 1;
            } else if (aValue < bValue) {
                comparison = -1;
            }

            return currentSortDirection === 'asc' ? comparison : -comparison;
        });

        renderHoldingsTable();
        updateSortIndicators();
    }

    // ソートインジケーターを更新
    function updateSortIndicators() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });

        if (currentSortField) {
            const fieldMap = {
                'ticker_symbol': 0,
                'security_name': 1,
                'total_cost': 5,
                'current_value': 6,
                'unrealized_pnl': 7,
                'unrealized_pnl_pct': 8,
                'day_change_pct': 9
            };
            const index = fieldMap[currentSortField];
            if (index !== undefined) {
                const headers = document.querySelectorAll('#holdings-table thead th');
                headers[index].classList.add(currentSortDirection);
            }
        }
    }

    // データを更新
    async function refreshData() {
        try {
            const response = await fetch('/api/stock-price/update-all', { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                await loadData();
                metricsData = []; // 評価指標キャッシュクリア
                alert('データを更新しました');
            }
        } catch (error) {
            console.error('データ更新エラー:', error);
            alert('データの更新に失敗しました');
        }
    }

    // ========== 評価指標関連の関数 ==========

    // 評価指標データを取得
    async function loadMetricsData() {
        console.log('[DEBUG] loadMetricsData 開始');
        const tbody = document.getElementById('metrics-tbody');
        tbody.innerHTML = '<tr><td colspan="14" class="text-center"><div class="loading">データを読み込み中...</div></td></tr>';

        try {
            console.log('[DEBUG] APIリクエスト送信: /api/holdings/metrics');
            const response = await fetch('/api/holdings/metrics');
            console.log('[DEBUG] レスポンス受信:', response.status, response.ok);

            const result = await response.json();
            console.log('[DEBUG] JSONパース完了:', result);
            console.log('[DEBUG] success:', result.success);
            console.log('[DEBUG] count:', result.count);
            console.log('[DEBUG] metrics length:', result.metrics ? result.metrics.length : 'undefined');

            if (result.success) {
                metricsData = result.metrics;
                console.log('[DEBUG] metricsData 設定完了:', metricsData.length, '件');
                renderMetricsTable();
            } else {
                console.error('[DEBUG] API成功フラグがfalse');
                tbody.innerHTML = '<tr><td colspan="14" class="text-center text-danger">評価指標の読み込みに失敗しました</td></tr>';
            }
        } catch (error) {
            console.error('[DEBUG] 評価指標データ取得エラー:', error);
            console.error('[DEBUG] エラー詳細:', error.message, error.stack);
            tbody.innerHTML = '<tr><td colspan="14" class="text-center text-danger">評価指標の読み込みに失敗しました: ' + error.message + '</td></tr>';
        }
    }

    // 評価指標テーブルを描画
    function renderMetricsTable() {
        console.log('[DEBUG] renderMetricsTable 開始');
        const tbody = document.getElementById('metrics-tbody');
        console.log('[DEBUG] tbody要素:', tbody);
        console.log('[DEBUG] metricsData件数:', metricsData.length);

        if (metricsData.length === 0) {
            console.log('[DEBUG] データなし');
            tbody.innerHTML = '<tr><td colspan="14" class="text-center">評価指標データがありません</td></tr>';
            return;
        }

        console.log('[DEBUG] テーブル描画開始');
        try {
            tbody.innerHTML = metricsData.map(m => `
            <tr>
                <td><strong>${m.ticker_symbol}</strong></td>
                <td>${getSecurityName(m.ticker_symbol)}</td>
                <td class="text-end">${formatMarketCap(m.market_cap, m.currency)}</td>
                <td class="text-end">${formatDecimal(m.beta, 2)}</td>
                <td class="text-end">${formatDecimal(m.pe_ratio, 2)}</td>
                <td class="text-end">${formatDecimal(m.eps, 2)}</td>
                <td>${format52WeekRange(m.fifty_two_week_low, m.fifty_two_week_high, m.currency)}</td>
                <td class="text-end ${getReturnClass(m.ytd_return)}">${formatPercentageMetrics(m.ytd_return)}</td>
                <td class="text-end ${getReturnClass(m.one_year_return)}">${formatPercentageMetrics(m.one_year_return)}</td>
                <td class="text-end">${formatDecimal(m.pb_ratio, 2)}</td>
                <td class="text-end">${formatDecimal(m.ev_to_revenue, 2)}</td>
                <td class="text-end">${formatDecimal(m.ev_to_ebitda, 2)}</td>
                <td class="text-end">${formatRevenue(m.revenue, m.currency)}</td>
                <td class="text-end">${formatPercentageMetrics(m.profit_margin)}</td>
            </tr>
        `).join('');
            console.log('[DEBUG] テーブル描画完了');
        } catch (error) {
            console.error('[DEBUG] テーブル描画エラー:', error);
            console.error('[DEBUG] エラー詳細:', error.message, error.stack);
            tbody.innerHTML = '<tr><td colspan="14" class="text-center text-danger">テーブルの描画に失敗しました: ' + error.message + '</td></tr>';
        }
    }

    // 銘柄名を取得（holdingsDataから）
    function getSecurityName(ticker) {
        const holding = holdingsData.find(h => h.ticker_symbol === ticker);
        return holding ? holding.security_name || '-' : '-';
    }

    // 時価総額フォーマット
    function formatMarketCap(value, currency) {
        if (!value) return '-';
        // すべての通貨で TN (Trillion), BN (Billion), MN (Million) - 小数点なし
        if (value >= 1e12) return (value / 1e12).toFixed(0) + 'TN';
        if (value >= 1e9) return (value / 1e9).toFixed(0) + 'BN';
        if (value >= 1e6) return (value / 1e6).toFixed(0) + 'MN';
        return value.toLocaleString();
    }

    // 小数フォーマット
    function formatDecimal(value, decimals) {
        if (value === null || value === undefined) return '-';
        return Number(value).toFixed(decimals);
    }

    // パーセンテージフォーマット（評価指標用）
    function formatPercentageMetrics(value) {
        if (value === null || value === undefined) return '-';
        const pct = value * 100;
        // 利益率の場合は+マークを付けない
        return pct.toFixed(2) + '%';
    }

    // 52週レンジフォーマット
    function format52WeekRange(low, high, currency) {
        if (!low || !high) return '-';
        return `${formatDecimal(low, 2)} - ${formatDecimal(high, 2)} ${currency}`;
    }

    // 売上フォーマット
    function formatRevenue(value, currency) {
        if (!value) return '-';
        // すべての通貨で TN (Trillion), BN (Billion), MN (Million) - 小数点なし
        if (value >= 1e12) return (value / 1e12).toFixed(0) + 'TN';
        if (value >= 1e9) return (value / 1e9).toFixed(0) + 'BN';
        if (value >= 1e6) return (value / 1e6).toFixed(0) + 'MN';
        return value.toLocaleString();
    }

    // リターンのクラス（正負で色分け）
    function getReturnClass(value) {
        if (value === null || value === undefined) return '';
        return value >= 0 ? 'positive' : 'negative';
    }

    // フォーマット関数
    function formatCurrency(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 0 });
    }

    function formatPrice(value, currency) {
        if (value === null || value === undefined) return '-';

        let decimals = 0;
        if (currency === 'USD') {
            decimals = 2;
        } else if (currency === 'JPY' || currency === '日本円' || currency === 'KRW') {
            decimals = 0;
        } else {
            decimals = 2;
        }

        return Number(value).toLocaleString('ja-JP', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatAverageCost(holding) {
        if (!holding.average_cost) return '-';

        // Holding.average_cost is always in JPY (Calculated from settlement amount)
        // Main display: JPY
        let result = `${formatCurrency(holding.average_cost)} JPY`;

        // Sub display: Foreign Currency
        const currency = holding.currency ? holding.currency.toUpperCase() : 'JPY';

        if (currency !== 'JPY' && currency !== '日本円') {
            // Try to find rate with normalized key
            let rateData = exchangeRates[currency];

            // If not found, try to look for keys case-insensitively
            if (!rateData) {
                const key = Object.keys(exchangeRates).find(k => k.toUpperCase() === currency);
                if (key) rateData = exchangeRates[key];
            }

            const rate = rateData?.rate;

            if (rate && rate > 0) {
                // Convert JPY back to Foreign Currency
                const foreignAmount = holding.average_cost / rate;
                const formattedForeign = formatPrice(foreignAmount, currency);

                // Display foreign amount in parentheses
                result += `<br><small style="color: #6c757d;">(${formattedForeign} ${currency})</small>`;
            } else {
                console.warn(`Rate not available for ${currency}`, exchangeRates);
                // Rate not available
                result += `<br><small style="color: #6c757d;">(Rate N/A)</small>`;
            }
        }

        return result;
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 4 });
    }

    function formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        const sign = value >= 0 ? '+' : '';
        return sign + Number(value).toFixed(2) + '%';
    }
</script>
{% endblock %}
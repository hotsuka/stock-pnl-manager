{% extends "base.html" %}

{% block title %}売却済み銘柄一覧 - Stock P&L Manager{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-top: 20px;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }

    .sortable:hover {
        background-color: #f8f9fa;
    }

    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }

    .sortable.asc::after {
        content: '▲';
        opacity: 1;
    }

    .sortable.desc::after {
        content: '▼';
        opacity: 1;
    }

    /* Sticky Header 修正版 */
    .table-responsive {
        overflow: visible !important;
    }

    #realized-pnl-table thead th {
        position: sticky;
        top: 56px;
        background-color: #fff !important;
        z-index: 1020;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-bottom: 2px solid #dee2e6;
    }

    #realized-pnl-table thead th.sortable:hover {
        background-color: #f8f9fa !important;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="realized-pnl-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>売却済み銘柄一覧</h1>
    </div>

    <!-- 売却済み銘柄テーブル -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-hover" id="realized-pnl-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortRealizedPnlTable('ticker_symbol')">ティッカー</th>
                        <th class="sortable" onclick="sortRealizedPnlTable('security_name')">銘柄名</th>
                        <th class="text-end">取得数量</th>
                        <th class="text-end">平均取得単価</th>
                        <th class="sortable text-end" onclick="sortRealizedPnlTable('sale_unit_price')">売却単価</th>
                        <th class="sortable text-end" onclick="sortRealizedPnlTable('total_cost')">取得コスト</th>
                        <th class="sortable text-end" onclick="sortRealizedPnlTable('sale_proceeds')">売却額</th>
                        <th class="sortable text-end" onclick="sortRealizedPnlTable('realized_pnl')">実現済み損益</th>
                        <th class="sortable text-end" onclick="sortRealizedPnlTable('realized_pnl_pct')">損益率</th>
                        <th class="sortable text-end" onclick="sortRealizedPnlTable('irr')">IRR</th>
                    </tr>
                </thead>
                <tbody id="realized-pnl-tbody">
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="loading">データを読み込み中...</div>
                        </td>
                    </tr>
                </tbody>
                <tfoot id="realized-pnl-tfoot" class="table-light d-none">
                    <tr>
                        <td colspan="5" class="text-end"><strong>合計</strong></td>
                        <td class="text-end" id="realized-total-cost"><strong>-</strong></td>
                        <td class="text-end" id="realized-total-proceeds"><strong>-</strong></td>
                        <td class="text-end" id="realized-total-pnl"><strong>-</strong></td>
                        <td class="text-end" id="realized-total-pnl-pct"><strong>-</strong></td>
                        <td class="text-end" id="realized-total-irr"><strong>-</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let realizedPnlData = [];
    let currentRealizedSortField = null;
    let currentRealizedSortDirection = 'asc';
    let exchangeRates = {};
    let irrData = {};

    // ページ読み込み時にデータ取得
    document.addEventListener('DOMContentLoaded', function () {
        loadData();
    });

    // データの読み込み
    async function loadData() {
        await loadExchangeRates();
        await loadRealizedPnlTable();
        await loadIrrData();
    }

    // IRRデータの読み込み
    async function loadIrrData() {
        try {
            const response = await fetch('/api/realized-pnl/irr');
            const result = await response.json();

            if (result.success) {
                irrData = result.irr_data;
                // IRRデータを各銘柄に追加
                realizedPnlData = realizedPnlData.map(r => ({
                    ...r,
                    irr: irrData[r.ticker_symbol]?.irr || null
                }));
                // テーブルを再描画
                renderRealizedPnlTable();
            }
        } catch (error) {
            console.error('IRRデータの読み込みエラー:', error);
        }
    }

    // 為替レートの読み込み
    async function loadExchangeRates() {
        try {
            const response = await fetch('/api/exchange-rate/multiple?currencies=USD,KRW');
            const result = await response.json();

            if (result.success) {
                exchangeRates = result.rates;
            }
        } catch (error) {
            console.error('為替レートの読み込みエラー:', error);
        }
    }

    async function loadRealizedPnlTable() {
        try {
            const response = await fetch('/api/realized-pnl');
            const result = await response.json();

            if (result.success && result.realized_pnl.length > 0) {
                realizedPnlData = result.realized_pnl;
                renderRealizedPnlTable(realizedPnlData);
            } else {
                document.getElementById('realized-pnl-tbody').innerHTML = '<tr><td colspan="10" class="text-center">売却済み銘柄がありません</td></tr>';
            }
        } catch (error) {
            console.error('実現損益データの読み込みエラー:', error);
            document.getElementById('realized-pnl-tbody').innerHTML = '<tr><td colspan="10" class="text-center text-danger">データの読み込みに失敗しました</td></tr>';
        }
    }

    function renderRealizedPnlTable(data) {
        const tbody = document.getElementById('realized-pnl-tbody');
        const tfoot = document.getElementById('realized-pnl-tfoot');

        if (!data) {
            data = realizedPnlData;
        }

        // Calculate totals
        let totalCost = 0;
        let totalProceeds = 0;
        let totalPnl = 0;
        let irrSum = 0;
        let irrCount = 0;

        const rows = data.map(r => {
            totalCost += r.total_cost || 0;
            totalProceeds += r.sale_proceeds || 0;
            totalPnl += r.realized_pnl || 0;

            // IRR集計
            if (r.irr !== null && r.irr !== undefined) {
                irrSum += r.irr;
                irrCount++;
            }

            const pnlClass = r.realized_pnl >= 0 ? 'text-success' : 'text-danger';
            const pnlPctClass = r.realized_pnl_pct >= 0 ? 'text-success' : 'text-danger';

            // IRRの表示
            let irrDisplay = '-';
            let irrClass = '';
            if (r.irr !== null && r.irr !== undefined) {
                irrClass = r.irr >= 0 ? 'text-success' : 'text-danger';
                const sign = r.irr >= 0 ? '+' : '';
                irrDisplay = `${sign}${r.irr.toFixed(2)}%`;
            }

            // Create object for sale unit price display
            const saleUnitPriceObj = {
                average_cost: r.sale_unit_price,
                currency: r.currency,
                total_cost: r.sale_proceeds,
                total_quantity: r.total_quantity
            };

            return `
                <tr>
                    <td>${r.ticker_symbol}</td>
                    <td>${r.security_name || '-'}</td>
                    <td class="text-end">${formatNumber(r.total_quantity)}</td>
                    <td class="text-end">${formatAverageCost(r)}</td>
                    <td class="text-end">${formatAverageCost(saleUnitPriceObj)}</td>
                    <td class="text-end">${formatCurrency(r.total_cost)}</td>
                    <td class="text-end">${formatCurrency(r.sale_proceeds)}</td>
                    <td class="text-end ${pnlClass}">${formatCurrency(r.realized_pnl)}</td>
                    <td class="text-end ${pnlPctClass}">${formatPercentage(r.realized_pnl_pct)}</td>
                    <td class="text-end ${irrClass}">${irrDisplay}</td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rows;

        // Update footer with totals
        const totalPnlPct = totalCost > 0 ? (totalPnl / totalCost * 100) : 0;
        const totalPnlClass = totalPnl >= 0 ? 'text-success' : 'text-danger';
        const totalPnlPctClass = totalPnlPct >= 0 ? 'text-success' : 'text-danger';

        // IRR平均
        const avgIrr = irrCount > 0 ? irrSum / irrCount : null;
        let avgIrrDisplay = '-';
        let avgIrrClass = '';
        if (avgIrr !== null) {
            avgIrrClass = avgIrr >= 0 ? 'text-success' : 'text-danger';
            const sign = avgIrr >= 0 ? '+' : '';
            avgIrrDisplay = `${sign}${avgIrr.toFixed(2)}%`;
        }

        document.getElementById('realized-total-cost').innerHTML = `<strong>${formatCurrency(totalCost)}</strong>`;
        document.getElementById('realized-total-proceeds').innerHTML = `<strong>${formatCurrency(totalProceeds)}</strong>`;
        document.getElementById('realized-total-pnl').innerHTML = `<strong class="${totalPnlClass}">${formatCurrency(totalPnl)}</strong>`;
        document.getElementById('realized-total-pnl-pct').innerHTML = `<strong class="${totalPnlPctClass}">${formatPercentage(totalPnlPct)}</strong>`;
        document.getElementById('realized-total-irr').innerHTML = `<strong class="${avgIrrClass}">${avgIrrDisplay}</strong>`;

        tfoot.classList.remove('d-none');
    }

    // 売却済み銘柄テーブルのソート
    function sortRealizedPnlTable(field) {
        if (currentRealizedSortField === field) {
            currentRealizedSortDirection = currentRealizedSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentRealizedSortField = field;
            currentRealizedSortDirection = 'asc';
        }

        realizedPnlData.sort((a, b) => {
            let aValue = a[field];
            let bValue = b[field];

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (typeof aValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            let comparison = 0;
            if (aValue > bValue) {
                comparison = 1;
            } else if (aValue < bValue) {
                comparison = -1;
            }

            return currentRealizedSortDirection === 'asc' ? comparison : -comparison;
        });

        renderRealizedPnlTable();
        updateRealizedSortIndicators();
    }

    // ソートインジケーターを更新
    function updateRealizedSortIndicators() {
        document.querySelectorAll('#realized-pnl-table .sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });

        if (currentRealizedSortField) {
            const fieldMap = {
                'ticker_symbol': 0,
                'security_name': 1,
                'sale_unit_price': 4,
                'total_cost': 5,
                'sale_proceeds': 6,
                'realized_pnl': 7,
                'realized_pnl_pct': 8,
                'irr': 9
            };
            const index = fieldMap[currentRealizedSortField];
            if (index !== undefined) {
                const headers = document.querySelectorAll('#realized-pnl-table thead th');
                headers[index].classList.add(currentRealizedSortDirection);
            }
        }
    }

    // フォーマット関数
    function formatCurrency(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 0 });
    }

    function formatPrice(value, currency) {
        if (value === null || value === undefined) return '-';

        let decimals = 0;
        if (currency === 'USD') {
            decimals = 2;
        } else if (currency === 'JPY' || currency === '日本円' || currency === 'KRW') {
            decimals = 0;
        } else {
            decimals = 2;
        }

        return Number(value).toLocaleString('ja-JP', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatAverageCost(holding) {
        if (!holding.average_cost) return '-';

        const avgCost = formatPrice(holding.average_cost, holding.currency);
        let result = `${avgCost} ${holding.currency}`;

        if (holding.currency !== 'JPY' && holding.currency !== '日本円') {
            if (holding.total_cost && holding.total_quantity) {
                const jpyPerShare = holding.total_cost / holding.total_quantity;
                result += `<br><small style="color: #6c757d;">(実質: ${formatCurrency(jpyPerShare)}円)</small>`;
            }
        }

        return result;
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 4 });
    }

    function formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        const sign = value >= 0 ? '+' : '';
        return sign + Number(value).toFixed(2) + '%';
    }
</script>
{% endblock %}
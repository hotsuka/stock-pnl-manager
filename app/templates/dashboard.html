{% extends "base.html" %}

{% block title %}ダッシュボード - Stock P&L Manager{% endblock %}

{% block extra_css %}
<style>
    .summary-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    .summary-card h3 {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 10px;
        font-weight: 500;
    }
    .summary-card .value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .summary-card .change {
        font-size: 0.9rem;
    }
    .positive {
        color: #28a745;
    }
    .negative {
        color: #dc3545;
    }
    .chart-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    .period-selector {
        margin-bottom: 15px;
    }
    .period-selector .btn {
        margin-right: 5px;
    }
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-top: 20px;
    }
    #holdings-tfoot tr {
        border-top: 2px solid #dee2e6;
        font-weight: bold;
    }
    #holdings-tfoot td {
        padding: 12px 8px;
    }
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }
    .sortable:hover {
        background-color: #f8f9fa;
    }
    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }
    .sortable.asc::after {
        content: '▲';
        opacity: 1;
    }
    .sortable.desc::after {
        content: '▼';
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ダッシュボード</h1>
        <button class="btn btn-primary" onclick="refreshAllData()">
            <i class="bi bi-arrow-clockwise"></i> データを更新
        </button>
    </div>

    <!-- サマリーカード -->
    <div class="row" id="summary-cards">
        <div class="col-md-3 col-sm-6">
            <div class="summary-card">
                <h3>総資産額</h3>
                <div class="value" id="total-asset">-</div>
                <div class="change text-muted">現在の評価額</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="summary-card">
                <h3>総投資額</h3>
                <div class="value" id="total-investment">-</div>
                <div class="change text-muted">取得コスト</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="summary-card">
                <h3>総合損益</h3>
                <div class="value" id="total-pnl">-</div>
                <div class="change" id="total-pnl-pct">-</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="summary-card">
                <h3>保有銘柄数</h3>
                <div class="value" id="holdings-count">-</div>
                <div class="change text-muted">銘柄</div>
            </div>
        </div>
    </div>

    <!-- 損益推移グラフ -->
    <div class="chart-container">
        <div class="chart-title">損益推移</div>
        <div class="period-selector">
            <button class="btn btn-sm btn-outline-primary active" data-period="30d" onclick="changePeriod('30d', this)">過去30日</button>
            <button class="btn btn-sm btn-outline-primary" data-period="1y" onclick="changePeriod('1y', this)">過去1年</button>
            <button class="btn btn-sm btn-outline-primary" data-period="all" onclick="changePeriod('all', this)">全期間</button>
        </div>
        <div id="pnl-chart" style="height: 400px;">
            <div class="loading">データを読み込み中...</div>
        </div>
    </div>

    <!-- グラフ行 -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">ポートフォリオ構成</div>
                <div id="portfolio-chart" style="height: 400px;">
                    <div class="loading">データを読み込み中...</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">保有銘柄別損益</div>
                <div id="holdings-chart" style="height: 400px;">
                    <div class="loading">データを読み込み中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 保有銘柄テーブル -->
    <div class="table-container">
        <div class="chart-title">保有銘柄一覧</div>

        <!-- 為替レート表示 -->
        <div class="alert alert-info mb-3" id="exchange-rates-display" style="display: none;">
            <strong>換算為替レート:</strong>
            <span id="exchange-rates-text">読み込み中...</span>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="holdings-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('ticker_symbol')">ティッカー</th>
                        <th class="sortable" onclick="sortTable('security_name')">銘柄名</th>
                        <th class="text-end">保有数量</th>
                        <th class="text-end">平均取得単価</th>
                        <th class="text-end">現在株価</th>
                        <th class="sortable text-end" onclick="sortTable('total_cost')">取得コスト</th>
                        <th class="sortable text-end" onclick="sortTable('current_value')">評価額</th>
                        <th class="sortable text-end" onclick="sortTable('unrealized_pnl')">未実現損益</th>
                        <th class="sortable text-end" onclick="sortTable('unrealized_pnl_pct')">損益率</th>
                        <th class="sortable text-end" onclick="sortTable('day_change_pct')">対前日変動率</th>
                    </tr>
                </thead>
                <tbody id="holdings-tbody">
                    <tr>
                        <td colspan="9" class="text-center">
                            <div class="loading">データを読み込み中...</div>
                        </td>
                    </tr>
                </tbody>
                <tfoot id="holdings-tfoot" class="table-light d-none">
                    <tr>
                        <td colspan="5" class="text-end"><strong>合計</strong></td>
                        <td class="text-end" id="total-cost"><strong>-</strong></td>
                        <td class="text-end" id="total-value"><strong>-</strong></td>
                        <td class="text-end" id="holdings-total-pnl"><strong>-</strong></td>
                        <td class="text-end" id="holdings-total-pnl-pct"><strong>-</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script>
    let currentPeriod = '30d';
    let holdingsData = [];
    let currentSortField = null;
    let currentSortDirection = 'asc';
    let exchangeRates = {};  // Store exchange rates

    // ページ読み込み時にデータ取得
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    // 全データの読み込み
    async function loadDashboardData() {
        // First load exchange rates
        await loadExchangeRates();

        // Then load other data
        await Promise.all([
            loadSummary(),
            loadPnlHistory(currentPeriod),
            loadHoldingsTable()  // This will also create the portfolio treemap
        ]);
    }

    // 為替レートの読み込み
    async function loadExchangeRates() {
        try {
            const response = await fetch('/api/exchange-rate/multiple?currencies=USD,KRW');
            const result = await response.json();

            if (result.success) {
                exchangeRates = result.rates;
                displayExchangeRates();
            }
        } catch (error) {
            console.error('為替レートの読み込みエラー:', error);
        }
    }

    // 為替レートの表示
    function displayExchangeRates() {
        const display = document.getElementById('exchange-rates-display');
        const text = document.getElementById('exchange-rates-text');

        const rates = [];
        if (exchangeRates.USD && exchangeRates.USD.rate) {
            rates.push(`USD/JPY: ${exchangeRates.USD.rate.toFixed(2)}`);
        }
        if (exchangeRates.KRW && exchangeRates.KRW.rate) {
            rates.push(`KRW/JPY: ${exchangeRates.KRW.rate.toFixed(4)}`);
        }

        if (rates.length > 0) {
            text.textContent = rates.join(' | ');
            display.style.display = 'block';
        }
    }

    // サマリーデータの読み込み
    async function loadSummary() {
        try {
            const response = await fetch('/api/dashboard/summary');
            const result = await response.json();

            if (result.success) {
                const summary = result.summary;

                document.getElementById('total-asset').textContent = formatCurrency(summary.total_asset_value);
                document.getElementById('total-investment').textContent = formatCurrency(summary.total_investment);
                document.getElementById('total-pnl').textContent = formatCurrency(summary.total_pnl);
                document.getElementById('total-pnl').className = 'value ' + (summary.total_pnl >= 0 ? 'positive' : 'negative');

                const pnlPctElement = document.getElementById('total-pnl-pct');
                pnlPctElement.textContent = formatPercentage(summary.total_pnl_pct);
                pnlPctElement.className = 'change ' + (summary.total_pnl >= 0 ? 'positive' : 'negative');

                document.getElementById('holdings-count').textContent = summary.holdings_count;
            }
        } catch (error) {
            console.error('サマリーデータの読み込みエラー:', error);
        }
    }

    // 損益推移グラフの読み込み
    async function loadPnlHistory(period) {
        try {
            const response = await fetch(`/api/dashboard/pnl-history?period=${period}`);
            const result = await response.json();

            if (result.success) {
                const data = result.data;

                const trace = {
                    x: data.map(d => d.date),
                    y: data.map(d => d.pnl),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: '損益',
                    line: {
                        color: '#0d6efd',
                        width: 2
                    },
                    marker: {
                        size: 4
                    }
                };

                const layout = {
                    margin: { t: 10, r: 30, b: 40, l: 80 },
                    xaxis: {
                        title: '日付',
                        type: 'date'
                    },
                    yaxis: {
                        title: '損益 (円)',
                        tickformat: ',.0f'
                    },
                    hovermode: 'closest',
                    showlegend: false
                };

                const config = {
                    responsive: true,
                    displayModeBar: false
                };

                Plotly.newPlot('pnl-chart', [trace], layout, config);
            }
        } catch (error) {
            console.error('損益推移データの読み込みエラー:', error);
            document.getElementById('pnl-chart').innerHTML = '<div class="loading text-danger">データの読み込みに失敗しました</div>';
        }
    }

    // ポートフォリオ構成円グラフの読み込み
    function createPortfolioTreemap(holdings) {
        if (!holdings || holdings.length === 0) {
            document.getElementById('portfolio-chart').innerHTML = '<div class="loading">保有銘柄がありません</div>';
            return;
        }

        // Filter holdings with valid data
        const validHoldings = holdings.filter(h => h.current_value && h.current_value > 0);

        if (validHoldings.length === 0) {
            document.getElementById('portfolio-chart').innerHTML = '<div class="loading">保有銘柄がありません</div>';
            return;
        }

        // Calculate P&L percentage for each holding
        const holdingsWithPnL = validHoldings.map(h => {
            const pnlPct = calculateUnrealizedPnLPct(h);
            return {
                name: h.security_name || h.ticker_symbol,
                value: convertToJPY(h.current_value, h.currency) || 0,
                pnlPct: pnlPct !== null ? pnlPct : 0
            };
        });

        const trace = {
            type: 'treemap',
            labels: holdingsWithPnL.map(h => h.name),
            parents: holdingsWithPnL.map(() => ''),
            values: holdingsWithPnL.map(h => h.value),
            text: holdingsWithPnL.map(h => `${formatCurrency(h.value)}<br>${formatPercentage(h.pnlPct)}`),
            textposition: 'middle center',
            marker: {
                colors: holdingsWithPnL.map(h => h.pnlPct),
                colorscale: [
                    [0, '#dc3545'],      // Red for negative
                    [0.5, '#ffc107'],    // Yellow for neutral
                    [1, '#28a745']       // Green for positive
                ],
                cmid: 0,
                colorbar: {
                    title: '損益率(%)',
                    ticksuffix: '%'
                }
            },
            hovertemplate: '<b>%{label}</b><br>評価額: %{value:,.0f} 円<br>損益率: %{color:.2f}%<extra></extra>'
        };

        const layout = {
            margin: { t: 30, r: 10, b: 10, l: 10 }
        };

        const config = {
            responsive: true,
            displayModeBar: false
        };

        Plotly.newPlot('portfolio-chart', [trace], layout, config);
    }

    async function loadPortfolioComposition() {
        // This function is now called from loadHoldingsTable
        // to ensure holdingsData is available
    }

    // 保有銘柄テーブルの読み込み
    async function loadHoldingsTable() {
        try {
            const response = await fetch('/api/holdings');
            const result = await response.json();

            if (result.success) {
                // Add calculated P&L values to each holding for sorting
                holdingsData = result.holdings.map(h => ({
                    ...h,
                    calculated_unrealized_pnl: calculateUnrealizedPnL(h),
                    calculated_unrealized_pnl_pct: calculateUnrealizedPnLPct(h)
                }));
                renderHoldingsTable();
                createPortfolioTreemap(holdingsData);
            }
        } catch (error) {
            console.error('保有銘柄データの読み込みエラー:', error);
            document.getElementById('holdings-tbody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">データの読み込みに失敗しました</td></tr>';
        }
    }

    // 通貨をJPYに換算
    function convertToJPY(amount, currency) {
        if (amount === null || amount === undefined) return null;

        const numAmount = parseFloat(amount);
        if (isNaN(numAmount)) return null;

        if (currency === 'JPY' || currency === '日本円') return numAmount;

        const rate = exchangeRates[currency]?.rate;
        if (!rate) return numAmount;  // レートがない場合は元の金額を返す

        return numAmount * rate;
    }

    // 株価を表示用にフォーマット（元の通貨 + JPY換算）
    function formatPriceWithConversion(price, currency) {
        if (!price) return '-';

        const priceStr = formatCurrency(price);

        if (currency === 'JPY' || currency === '日本円') {
            return priceStr;
        }

        const jpyAmount = convertToJPY(price, currency);
        if (jpyAmount && jpyAmount !== price) {
            return `${priceStr} ${currency}<br><small>(${formatCurrency(jpyAmount)} JPY)</small>`;
        }

        return `${priceStr} ${currency}`;
    }

    // 株価を表示用にフォーマット（現在株価 + JPY換算 + 前日終値）
    function formatPriceWithPreviousClose(currentPrice, previousClose, currency) {
        if (!currentPrice) return '-';

        const priceStr = formatCurrency(currentPrice);
        let result = priceStr;

        // Add currency for foreign stocks
        if (currency !== 'JPY' && currency !== '日本円') {
            result += ` ${currency}`;

            // Add JPY conversion
            const jpyAmount = convertToJPY(currentPrice, currency);
            if (jpyAmount && jpyAmount !== currentPrice) {
                result += `<br><small>(${formatCurrency(jpyAmount)} JPY)</small>`;
            }
        }

        // Add previous close
        if (previousClose !== null && previousClose !== undefined) {
            result += `<br><small style="color: #6c757d;">(前日: ${formatCurrency(previousClose)})</small>`;
        }

        return result;
    }

    // 評価額を表示用にフォーマット（JPYのみ）
    function formatValueInJPY(value, currency) {
        if (!value) return '-';

        const jpyAmount = convertToJPY(value, currency);
        return formatCurrency(jpyAmount);
    }

    // 未実現損益を計算（評価額(JPY) - 取得コスト）
    function calculateUnrealizedPnL(holding) {
        if (holding.current_value === null || holding.current_value === undefined ||
            holding.total_cost === null || holding.total_cost === undefined) {
            return null;
        }

        const currentValueJPY = convertToJPY(holding.current_value, holding.currency);
        if (currentValueJPY === null) return null;

        const totalCost = parseFloat(holding.total_cost);
        if (isNaN(totalCost)) return null;

        return currentValueJPY - totalCost;
    }

    // 未実現損益率を計算
    function calculateUnrealizedPnLPct(holding) {
        const pnl = calculateUnrealizedPnL(holding);
        if (pnl === null || !holding.total_cost) return null;

        const totalCost = parseFloat(holding.total_cost);
        if (totalCost === 0) return null;

        return (pnl / totalCost) * 100;
    }

    function renderHoldingsTable() {
        const tbody = document.getElementById('holdings-tbody');

        if (holdingsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">保有銘柄がありません</td></tr>';
            document.getElementById('holdings-tfoot').classList.add('d-none');
            document.getElementById('holdings-chart').innerHTML = '<div class="loading">保有銘柄がありません</div>';
            return;
        }

        tbody.innerHTML = holdingsData.map(h => {
            const unrealizedPnL = calculateUnrealizedPnL(h);
            const unrealizedPnLPct = calculateUnrealizedPnLPct(h);
            const pnlClass = unrealizedPnL !== null && unrealizedPnL >= 0 ? 'positive' : 'negative';

            return `
                <tr>
                    <td><strong>${h.ticker_symbol}</strong></td>
                    <td>${h.security_name || '-'}</td>
                    <td class="text-end">${formatNumber(h.total_quantity)}</td>
                    <td class="text-end">${formatCurrency(h.average_cost)} ${h.currency}</td>
                    <td class="text-end">${formatPriceWithPreviousClose(h.current_price, h.previous_close, h.currency)}</td>
                    <td class="text-end">${h.total_cost ? formatCurrency(h.total_cost) : '-'}</td>
                    <td class="text-end">${formatValueInJPY(h.current_value, h.currency)}</td>
                    <td class="text-end ${pnlClass}">
                        ${unrealizedPnL !== null ? formatCurrency(unrealizedPnL) : '-'}
                    </td>
                    <td class="text-end ${pnlClass}">
                        ${unrealizedPnLPct !== null ? formatPercentage(unrealizedPnLPct) : '-'}
                    </td>
                    <td class="text-end ${h.day_change_pct !== null && h.day_change_pct >= 0 ? 'positive' : 'negative'}">
                        ${h.day_change_pct !== null ? formatPercentage(h.day_change_pct) : '-'}
                    </td>
                </tr>
            `;
        }).join('');

        // Calculate and display totals
        const totalCost = holdingsData.reduce((sum, h) => sum + (parseFloat(h.total_cost) || 0), 0);
        const totalValue = holdingsData.reduce((sum, h) => {
            const valueJPY = convertToJPY(h.current_value, h.currency);
            return sum + (valueJPY !== null && !isNaN(valueJPY) ? valueJPY : 0);
        }, 0);
        const totalPnL = holdingsData.reduce((sum, h) => {
            const pnl = calculateUnrealizedPnL(h);
            return sum + (pnl !== null && !isNaN(pnl) ? pnl : 0);
        }, 0);

        document.getElementById('total-cost').innerHTML = `<strong>${formatCurrency(totalCost)}</strong>`;
        document.getElementById('total-value').innerHTML = `<strong>${formatCurrency(totalValue)}</strong>`;

        const pnlClass = totalPnL >= 0 ? 'positive' : 'negative';
        document.getElementById('holdings-total-pnl').innerHTML = `<strong class="${pnlClass}">${formatCurrency(totalPnL)}</strong>`;
        document.getElementById('holdings-total-pnl').className = `text-end ${pnlClass}`;

        // Calculate and display total P&L percentage
        const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
        document.getElementById('holdings-total-pnl-pct').innerHTML = `<strong class="${pnlClass}">${formatPercentage(totalPnLPct)}</strong>`;
        document.getElementById('holdings-total-pnl-pct').className = `text-end ${pnlClass}`;

        document.getElementById('holdings-tfoot').classList.remove('d-none');

        // Create holdings bar chart for P&L
        createHoldingsPnlChart(holdingsData);
    }

    // テーブルの並べ替え
    function sortTable(field) {
        // 同じフィールドをクリックした場合は昇順/降順を切り替え
        if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortDirection = 'asc';
        }

        // データを並べ替え
        holdingsData.sort((a, b) => {
            // Map field names to actual data fields
            let fieldName = field;
            if (field === 'unrealized_pnl') {
                fieldName = 'calculated_unrealized_pnl';
            } else if (field === 'unrealized_pnl_pct') {
                fieldName = 'calculated_unrealized_pnl_pct';
            }

            let aValue = a[fieldName];
            let bValue = b[fieldName];

            // null/undefined を処理
            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            // 文字列の場合は大文字小文字を区別せずに比較
            if (typeof aValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            let comparison = 0;
            if (aValue > bValue) {
                comparison = 1;
            } else if (aValue < bValue) {
                comparison = -1;
            }

            return currentSortDirection === 'asc' ? comparison : -comparison;
        });

        // テーブルを再描画
        renderHoldingsTable();

        // ソートインジケーターを更新
        updateSortIndicators();
    }

    // ソートインジケーターを更新
    function updateSortIndicators() {
        // すべてのソートクラスを削除
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });

        // 現在のソート列にクラスを追加
        if (currentSortField) {
            const fieldMap = {
                'ticker_symbol': 0,
                'security_name': 1,
                'total_cost': 5,
                'current_value': 6,
                'unrealized_pnl': 7,
                'unrealized_pnl_pct': 8,
                'day_change_pct': 9
            };
            const index = fieldMap[currentSortField];
            if (index !== undefined) {
                const headers = document.querySelectorAll('#holdings-table thead th');
                headers[index].classList.add(currentSortDirection);
            }
        }
    }

    // 保有銘柄別損益バーチャート
    function createHoldingsPnlChart(holdings) {
        // Calculate P&L for each holding
        const holdingsWithPnL = holdings.map(h => ({
            ...h,
            calculatedPnL: calculateUnrealizedPnL(h)
        }));

        const validHoldings = holdingsWithPnL.filter(h => h.calculatedPnL !== null);

        if (validHoldings.length === 0) {
            document.getElementById('holdings-chart').innerHTML = '<div class="loading">損益データがありません</div>';
            return;
        }

        // Sort by unrealized P&L
        validHoldings.sort((a, b) => b.calculatedPnL - a.calculatedPnL);

        const trace = {
            x: validHoldings.map(h => h.security_name || h.ticker_symbol),
            y: validHoldings.map(h => h.calculatedPnL),
            type: 'bar',
            marker: {
                color: validHoldings.map(h => h.calculatedPnL >= 0 ? '#28a745' : '#dc3545')
            },
            text: validHoldings.map(h => formatCurrency(h.calculatedPnL)),
            textposition: 'auto',
            hoverinfo: 'x+y'
        };

        const layout = {
            margin: { t: 10, r: 30, b: 120, l: 80 },
            xaxis: {
                title: '銘柄',
                tickangle: -45,
                automargin: true,
                tickfont: {
                    size: 10
                }
            },
            yaxis: {
                title: '未実現損益 (円)',
                tickformat: ',.0f',
                automargin: true
            },
            showlegend: false
        };

        const config = {
            responsive: true,
            displayModeBar: false
        };

        Plotly.newPlot('holdings-chart', [trace], layout, config);
    }

    // 期間変更
    function changePeriod(period, button) {
        currentPeriod = period;

        // ボタンのアクティブ状態を更新
        document.querySelectorAll('.period-selector .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');

        // グラフを再読み込み
        loadPnlHistory(period);
    }

    // 全データを更新
    async function refreshAllData() {
        // まず株価を更新
        try {
            const response = await fetch('/api/stock-price/update-all', { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                // 更新後にダッシュボードデータを再読み込み
                await loadDashboardData();
                alert('データを更新しました');
            }
        } catch (error) {
            console.error('データ更新エラー:', error);
            alert('データの更新に失敗しました');
        }
    }

    // フォーマット関数
    function formatCurrency(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 0 });
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 4 });
    }

    function formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        const sign = value >= 0 ? '+' : '';
        return sign + Number(value).toFixed(2) + '%';
    }
</script>
{% endblock %}

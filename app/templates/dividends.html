{% extends "base.html" %}

{% block title %}配当受取一覧 - Stock P&L Manager{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-top: 20px;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }

    .sortable:hover {
        background-color: #f8f9fa;
    }

    .sortable::after {
        content: '⇅';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }

    .sortable.asc::after {
        content: '▲';
        opacity: 1;
    }

    .sortable.desc::after {
        content: '▼';
        opacity: 1;
    }

    /* Sticky Header 修正版 */
    .table-responsive {
        overflow: visible !important;
    }

    #dividends-table thead th {
        position: sticky;
        top: 56px;
        background-color: #fff !important;
        z-index: 1020;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-bottom: 2px solid #dee2e6;
    }

    /* ソート可能なヘッダーのホバー色も sticky 維持のため調整 */
    #dividends-table thead th.sortable:hover {
        background-color: #f8f9fa !important;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .year-column {
        min-width: 100px;
    }

    #dividends-tfoot tr {
        border-top: 2px solid #dee2e6;
        font-weight: bold;
    }

    #dividends-tfoot td {
        padding: 12px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dividends-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>配当受取一覧</h1>
        <button class="btn btn-primary" onclick="refreshDividendData()">
            <i class="bi bi-arrow-clockwise"></i> データを更新
        </button>
    </div>

    <!-- 配当一覧テーブル -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-hover" id="dividends-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('ticker_symbol')">ティッカー</th>
                        <th class="sortable" onclick="sortTable('security_name')">銘柄名</th>
                        <th class="sortable text-end" onclick="sortTable('total_dividends')">総配当受取額</th>
                        <th class="sortable text-end" onclick="sortTable('dividend_yield')">総配当利回り</th>
                        <th class="text-end year-column" id="year-headers">
                            <!-- Year columns will be added dynamically -->
                        </th>
                    </tr>
                </thead>
                <tbody id="dividends-tbody">
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="loading">データを読み込み中...</div>
                        </td>
                    </tr>
                </tbody>
                <tfoot id="dividends-tfoot" class="table-light d-none">
                    <tr>
                        <td colspan="2" class="text-end"><strong>合計</strong></td>
                        <td class="text-end" id="total-dividends"><strong>-</strong></td>
                        <td class="text-end" id="total-yield"><strong>-</strong></td>
                        <td class="text-end" id="yearly-totals">
                            <!-- Yearly totals will be added dynamically -->
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let dividendsData = [];
    let currentSortField = null;
    let currentSortDirection = 'asc';
    let allYears = [];

    // ページ読み込み時にデータ取得
    document.addEventListener('DOMContentLoaded', function () {
        loadDividendData();
    });

    // 配当データの読み込み
    async function loadDividendData() {
        try {
            const response = await fetch('/api/dividends/summary');
            const result = await response.json();

            if (result.success) {
                dividendsData = result.dividends;

                // Extract all years from the data
                const yearsSet = new Set();
                dividendsData.forEach(d => {
                    Object.keys(d.yearly_dividends).forEach(year => yearsSet.add(parseInt(year)));
                });
                if (result.totals.yearly_totals) {
                    Object.keys(result.totals.yearly_totals).forEach(year => yearsSet.add(parseInt(year)));
                }
                allYears = Array.from(yearsSet).sort((a, b) => b - a);

                renderDividendTable(result.totals);
            } else {
                document.getElementById('dividends-tbody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">データの読み込みに失敗しました</td></tr>';
            }
        } catch (error) {
            console.error('配当データの読み込みエラー:', error);
            document.getElementById('dividends-tbody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">データの読み込みに失敗しました</td></tr>';
        }
    }

    function renderDividendTable(totals) {
        const thead = document.querySelector('#dividends-table thead tr');
        const tbody = document.getElementById('dividends-tbody');
        const tfoot = document.getElementById('dividends-tfoot');

        if (dividendsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="' + (4 + allYears.length) + '" class="text-center">配当データがありません</td></tr>';
            tfoot.classList.add('d-none');
            return;
        }

        // Add year headers
        const yearHeadersContainer = document.getElementById('year-headers');
        if (allYears.length > 0 && yearHeadersContainer) {
            // Remove the year-headers placeholder th
            yearHeadersContainer.remove();

            // Add year columns
            allYears.forEach(year => {
                const th = document.createElement('th');
                th.className = 'text-end year-column';
                th.textContent = `${year}年`;
                thead.appendChild(th);
            });
        }

        // Render table rows
        tbody.innerHTML = dividendsData.map(d => {
            const yearCells = allYears.map(year => {
                const amount = d.yearly_dividends[year.toString()] || 0;
                return `<td class="text-end">${formatCurrency(amount)}</td>`;
            }).join('');

            return `
                <tr>
                    <td><strong>${d.ticker_symbol}</strong></td>
                    <td>${d.security_name || '-'}</td>
                    <td class="text-end">${formatCurrency(d.total_dividends)}</td>
                    <td class="text-end">${formatPercentage(d.dividend_yield)}</td>
                    ${yearCells}
                </tr>
            `;
        }).join('');

        // Render totals footer
        const footerRow = tfoot.querySelector('tr');

        // Update colspan for "合計" cell
        footerRow.cells[0].setAttribute('colspan', '2');

        // Update total dividends
        document.getElementById('total-dividends').innerHTML = `<strong>${formatCurrency(totals.total_dividends)}</strong>`;

        // Update total yield
        document.getElementById('total-yield').innerHTML = `<strong>${formatPercentage(totals.dividend_yield)}</strong>`;

        // Update yearly totals
        const yearlyTotalsContainer = document.getElementById('yearly-totals');
        if (allYears.length > 0 && yearlyTotalsContainer) {
            // Remove the yearly-totals placeholder td
            yearlyTotalsContainer.remove();

            // Add yearly total cells
            allYears.forEach(year => {
                const td = document.createElement('td');
                td.className = 'text-end';
                const amount = totals.yearly_totals[year.toString()] || 0;
                td.innerHTML = `<strong>${formatCurrency(amount)}</strong>`;
                footerRow.appendChild(td);
            });
        }

        tfoot.classList.remove('d-none');
    }

    // テーブルの並べ替え
    function sortTable(field) {
        if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortDirection = 'asc';
        }

        dividendsData.sort((a, b) => {
            let aValue = a[field];
            let bValue = b[field];

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (typeof aValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            let comparison = 0;
            if (aValue > bValue) {
                comparison = 1;
            } else if (aValue < bValue) {
                comparison = -1;
            }

            return currentSortDirection === 'asc' ? comparison : -comparison;
        });

        // Re-render table body only (keep headers and footer)
        const tbody = document.getElementById('dividends-tbody');
        tbody.innerHTML = dividendsData.map(d => {
            const yearCells = allYears.map(year => {
                const amount = d.yearly_dividends[year.toString()] || 0;
                return `<td class="text-end">${formatCurrency(amount)}</td>`;
            }).join('');

            return `
                <tr>
                    <td><strong>${d.ticker_symbol}</strong></td>
                    <td>${d.security_name || '-'}</td>
                    <td class="text-end">${formatCurrency(d.total_dividends)}</td>
                    <td class="text-end">${formatPercentage(d.dividend_yield)}</td>
                    ${yearCells}
                </tr>
            `;
        }).join('');

        updateSortIndicators();
    }

    // ソートインジケーターを更新
    function updateSortIndicators() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });

        if (currentSortField) {
            const fieldMap = {
                'ticker_symbol': 0,
                'security_name': 1,
                'total_dividends': 2,
                'dividend_yield': 3
            };
            const index = fieldMap[currentSortField];
            if (index !== undefined) {
                const headers = document.querySelectorAll('#dividends-table thead th');
                headers[index].classList.add(currentSortDirection);
            }
        }
    }

    // 配当データを更新
    async function refreshDividendData() {
        if (!confirm('配当データを更新します。Yahoo Financeから最新の配当データを取得するため、時間がかかる場合があります。よろしいですか？')) {
            return;
        }

        try {
            // Show loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                           background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                           align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; text-align: center;">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="mb-0">配当データを更新中です...<br>しばらくお待ちください</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingOverlay);

            // Call API to update dividends
            const response = await fetch('/api/dividends/update-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            // Remove loading overlay
            document.body.removeChild(loadingOverlay);

            if (result.success) {
                alert(`配当データの更新が完了しました。\n\n処理した銘柄数: ${result.total_holdings}\n成功: ${result.success}\n失敗: ${result.failed}`);
                // Reload page to show updated data
                window.location.reload();
            } else {
                alert('配当データの更新に失敗しました: ' + (result.error || '不明なエラー'));
            }
        } catch (error) {
            console.error('データ更新エラー:', error);
            alert('データの更新に失敗しました: ' + error.message);
        }
    }

    // フォーマット関数
    function formatCurrency(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toLocaleString('ja-JP', { maximumFractionDigits: 0 });
    }

    function formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        return Number(value).toFixed(2) + '%';
    }
</script>
{% endblock %}
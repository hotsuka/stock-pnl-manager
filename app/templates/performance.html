{% extends "base.html" %}

{% block title %}損益推移 - Stock PnL Manager{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>損益推移</h2>
        <div class="d-flex gap-2 align-items-center">
            <div class="btn-group" role="group" aria-label="表示期間の切替">
                <button type="button" class="btn btn-outline-primary active" id="btn-1m" onclick="changePeriod('1m')">過去1か月
                    (日次)</button>
                <button type="button" class="btn btn-outline-primary" id="btn-1y" onclick="changePeriod('1y')">過去1年
                    (月次)</button>
            </div>
            <div class="benchmark-controls ms-3">
                <label class="form-label mb-0 me-2">ベンチマーク:</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="benchmark-topix"
                           value="TOPIX" checked onchange="updateBenchmarkDisplay()">
                    <label class="form-check-label" for="benchmark-topix">日経平均225</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="benchmark-sp500"
                           value="SP500" checked onchange="updateBenchmarkDisplay()">
                    <label class="form-check-label" for="benchmark-sp500">S&P 500</label>
                </div>
            </div>
            <button type="button" class="btn btn-outline-secondary" onclick="refreshData()" id="btn-refresh" title="データを最新に更新">
                <i class="bi bi-arrow-clockwise"></i> 更新
            </button>
        </div>
    </div>

    <!-- グラフセクション -->
    <div class="card mb-4">
        <div class="card-body">
            <div id="performance-chart" style="height: 500px; width: 100%;">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">データを計算中... (過去の株価取得に時間がかかる場合があります)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- テーブルセクション -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">損益詳細</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="exportToCSV()">CSVダウンロード</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="performance-table">
                    <thead class="table-light">
                        <tr>
                            <th>日付</th>
                            <th class="text-end">合計</th>
                            <th class="text-end">A. 保有損益</th>
                            <th class="text-end">B. 実現損益</th>
                            <th class="text-end">C. 受取配当</th>
                        </tr>
                    </thead>
                    <tbody id="performance-tbody">
                        <!-- JS で生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 詳細モーダル -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel">損益詳細</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="detailContent">
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .year-column {
        background-color: #f8f9fa;
    }

    #performance-chart {
        min-height: 400px;
    }

    .text-positive {
        color: #28a745;
    }

    .text-negative {
        color: #dc3545;
    }

    .clickable-cell {
        cursor: pointer;
        text-decoration: underline;
        text-decoration-style: dotted;
    }

    .clickable-cell:hover {
        background-color: #f8f9fa;
    }

    .detail-section {
        margin-bottom: 30px;
    }

    .detail-section h6 {
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .modal-sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
    }

    .modal-sortable:hover {
        background-color: #e9ecef;
    }

    .modal-sortable::after {
        content: '';
        position: absolute;
        right: 5px;
    }

    .modal-sortable.asc::after {
        content: '▲';
        opacity: 1;
    }

    .modal-sortable.desc::after {
        content: '▼';
        opacity: 1;
    }
</style>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<script>
    let currentPeriod = '1m';
    let performanceData = [];
    let detailCache = {}; // 詳細データのキャッシュ
    const CACHE_EXPIRY = 5 * 60 * 1000; // 5分間

    document.addEventListener('DOMContentLoaded', function () {
        loadData('1m');
    });

    /**
     * キャッシュからデータを取得
     */
    function getCachedData(period) {
        const cacheKey = `performance_${period}`;
        const cached = sessionStorage.getItem(cacheKey);
        if (!cached) return null;

        try {
            const data = JSON.parse(cached);
            const now = Date.now();
            // キャッシュの有効期限をチェック
            if (now - data.timestamp < CACHE_EXPIRY) {
                console.log(`Using cached data for period: ${period}`);
                return data.data;
            } else {
                sessionStorage.removeItem(cacheKey);
                return null;
            }
        } catch (e) {
            console.error('Cache parse error:', e);
            sessionStorage.removeItem(cacheKey);
            return null;
        }
    }

    /**
     * データをキャッシュに保存
     */
    function setCachedData(period, data) {
        const cacheKey = `performance_${period}`;
        const cacheData = {
            timestamp: Date.now(),
            data: data
        };
        try {
            sessionStorage.setItem(cacheKey, JSON.stringify(cacheData));
        } catch (e) {
            console.warn('Failed to cache data:', e);
        }
    }

    /**
     * データを読み込む（キャッシュ優先）
     */
    async function loadData(period, forceRefresh = false) {
        console.log(`[DEBUG] loadData called: period=${period}, forceRefresh=${forceRefresh}`);
        currentPeriod = period;

        // ボタンの状態を更新
        document.getElementById('btn-1m').classList.toggle('active', period === '1m');
        document.getElementById('btn-1y').classList.toggle('active', period === '1y');

        // キャッシュをチェック（強制更新でない場合）
        if (!forceRefresh) {
            const cached = getCachedData(period);
            if (cached) {
                console.log(`[DEBUG] Using cached data`);
                performanceData = cached;
                renderChart();
                renderTable();
                showCacheIndicator();
                return;
            }
        }

        // ローディング表示
        document.getElementById('performance-tbody').innerHTML = '<tr><td colspan="5" class="text-center">データを読み込み中...</td></tr>';

        try {
            console.log(`[DEBUG] Fetching from API: /api/performance/history?period=${period}&benchmarks=true`);
            const response = await fetch(`/api/performance/history?period=${period}&benchmarks=true`);
            console.log(`[DEBUG] Response status: ${response.status}`);

            const result = await response.json();
            console.log(`[DEBUG] Response data:`, result);

            if (result.success) {
                performanceData = result.data;
                console.log(`[DEBUG] Portfolio data count: ${performanceData.portfolio ? performanceData.portfolio.length : 0}`);

                // キャッシュに保存
                setCachedData(period, performanceData);

                console.log(`[DEBUG] Rendering chart...`);
                renderChart();

                console.log(`[DEBUG] Rendering table...`);
                renderTable();

                hideCacheIndicator();
                console.log(`[DEBUG] loadData completed successfully`);
            } else {
                console.error(`[DEBUG] API returned success=false:`, result);
                showError('データの取得に失敗しました');
            }
        } catch (error) {
            console.error('[DEBUG] Error in loadData:', error);
            console.error('[DEBUG] Error stack:', error.stack);
            showError(`通信エラーが発生しました: ${error.message}`);
        }
    }

    function changePeriod(period) {
        if (currentPeriod === period) return;
        loadData(period);
    }

    /**
     * データを強制的に再読み込み
     */
    function refreshData() {
        const btn = document.getElementById('btn-refresh');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>更新中...';

        // キャッシュをクリア
        sessionStorage.removeItem(`performance_${currentPeriod}`);
        detailCache = {}; // 詳細キャッシュもクリア

        loadData(currentPeriod, true).finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 更新';
        });
    }

    /**
     * ベンチマーク表示の切替
     */
    function updateBenchmarkDisplay() {
        console.log('[DEBUG] updateBenchmarkDisplay called');
        renderChart();
    }

    /**
     * キャッシュ使用中インジケーターを表示
     */
    function showCacheIndicator() {
        const chartDiv = document.getElementById('performance-chart');
        let indicator = document.getElementById('cache-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'cache-indicator';
            indicator.className = 'alert alert-info alert-dismissible fade show position-absolute top-0 end-0 m-2';
            indicator.style.zIndex = '1000';
            indicator.innerHTML = `
                <small>
                    <i class="bi bi-clock-history"></i> キャッシュデータを表示中（最新データは「更新」ボタンをクリック）
                </small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            chartDiv.style.position = 'relative';
            chartDiv.appendChild(indicator);
        }
    }

    /**
     * キャッシュインジケーターを非表示
     */
    function hideCacheIndicator() {
        const indicator = document.getElementById('cache-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    function renderChart() {
        try {
            console.log('[DEBUG] renderChart: Starting chart rendering');

            // Check if Plotly is loaded
            if (typeof Plotly === 'undefined') {
                console.error('[DEBUG] Plotly is not defined!');
                showError('Plotlyライブラリが読み込まれていません');
                return;
            }

            // データ構造の変更に対応: performanceData.portfolioを使用
            const portfolioData = performanceData.portfolio || performanceData;

            if (!portfolioData || portfolioData.length === 0) {
                console.log('[DEBUG] No data to render');
                document.getElementById('performance-chart').innerHTML = '<div class="alert alert-info mx-5 mt-5">表示するデータがありません</div>';
                return;
            }

            console.log('[DEBUG] Processing data for chart...');
            const dates = portfolioData.map(d => d.date);
            const holding = portfolioData.map(d => d.holding_pnl);
            const realized = portfolioData.map(d => d.realized_pnl);
            const dividend = portfolioData.map(d => d.dividend_income);

            const trace1 = {
                x: dates,
                y: holding,
                name: 'A. 保有損益',
                type: 'bar',
                marker: { color: '#4a90e2' }
            };

            const trace2 = {
                x: dates,
                y: realized,
                name: 'B. 実現損益',
                type: 'bar',
                marker: { color: '#f39c12' }
            };

            const trace3 = {
                x: dates,
                y: dividend,
                name: 'C. 受取配当',
                type: 'bar',
                marker: { color: '#27ae60' }
            };

            // ベンチマークトレースを追加
            const traces = [trace1, trace2, trace3];

            // TOPIXベンチマーク
            if (document.getElementById('benchmark-topix').checked &&
                performanceData.benchmarks && performanceData.benchmarks.TOPIX) {
                const topixDates = performanceData.benchmarks.TOPIX.map(d => d.date);
                const topixVirtualPnl = performanceData.benchmarks.TOPIX.map(d => d.virtual_pnl);

                traces.push({
                    x: topixDates,
                    y: topixVirtualPnl,
                    type: 'scatter',
                    mode: 'markers',
                    marker: {
                        color: '#ff6b6b',
                        size: 8,
                        symbol: 'circle'
                    },
                    name: '日経平均基準損益',
                    hovertemplate: '<b>日経平均基準</b><br>日付: %{x}<br>仮想損益: %{y:,.0f}円<extra></extra>'
                });
            }

            // S&P 500ベンチマーク
            if (document.getElementById('benchmark-sp500').checked &&
                performanceData.benchmarks && performanceData.benchmarks.SP500) {
                const sp500Dates = performanceData.benchmarks.SP500.map(d => d.date);
                const sp500VirtualPnl = performanceData.benchmarks.SP500.map(d => d.virtual_pnl);

                traces.push({
                    x: sp500Dates,
                    y: sp500VirtualPnl,
                    type: 'scatter',
                    mode: 'markers',
                    marker: {
                        color: '#4ecdc4',
                        size: 8,
                        symbol: 'diamond'
                    },
                    name: 'S&P 500基準損益',
                    hovertemplate: '<b>S&P 500基準</b><br>日付: %{x}<br>仮想損益: %{y:,.0f}円<extra></extra>'
                });
            }

            const layout = {
                barmode: 'relative', // 正負両方の積み上げに対応
                title: currentPeriod === '1m' ? '日次損益推移 (過去30日)' : '月次損益推移 (過去1年)',
                xaxis: {
                    title: '日付',
                    tickangle: -45,
                    type: 'category'
                },
                yaxis: {
                    title: '損益額 (JPY)',
                    zeroline: true,
                    zerolinecolor: '#999',
                    zerolinewidth: 2
                },
                margin: { b: 100, l: 80, r: 20, t: 40 },
                legend: { orientation: 'h', y: -0.2 },
                hovermode: 'closest'
            };

            const config = { responsive: true };

            // ローディングスピナーを明示的にクリア
            const chartDiv = document.getElementById('performance-chart');
            chartDiv.innerHTML = ''; // 既存の内容をクリア

            console.log('[DEBUG] Calling Plotly.newPlot...');
            Plotly.newPlot('performance-chart', traces, layout, config)
                .then(() => {
                    console.log('[DEBUG] Chart rendered successfully');
                })
                .catch(error => {
                    console.error('[DEBUG] Plotly.newPlot failed:', error);
                    showError(`グラフの描画に失敗しました: ${error.message}`);
                });
        } catch (error) {
            console.error('[DEBUG] Error in renderChart:', error);
            console.error('[DEBUG] Error stack:', error.stack);
            showError(`グラフの描画エラー: ${error.message}`);
        }
    }

    function renderTable() {
        const tbody = document.getElementById('performance-tbody');

        // データ構造の変更に対応: performanceData.portfolioを使用
        const portfolioData = performanceData.portfolio || performanceData;

        if (!portfolioData || portfolioData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">データがありません</td></tr>';
            return;
        }

        // 最新の日付を上に表示
        const sortedData = [...portfolioData].reverse();

        tbody.innerHTML = sortedData.map(d => {
            const totalClass = d.total >= 0 ? 'text-positive' : 'text-negative';
            const hClass = d.holding_pnl >= 0 ? 'text-positive' : 'text-negative';
            const rClass = d.realized_pnl >= 0 ? 'text-positive' : 'text-negative';

            return `
                <tr>
                    <td>${d.date}</td>
                    <td class="text-end fw-bold ${totalClass}">${formatCurrency(d.total)}</td>
                    <td class="text-end ${hClass} clickable-cell" onclick="showDetail('${d.date}', 'holding')">${formatCurrency(d.holding_pnl)}</td>
                    <td class="text-end ${rClass} clickable-cell" onclick="showDetail('${d.date}', 'realized')">${formatCurrency(d.realized_pnl)}</td>
                    <td class="text-end text-positive clickable-cell" onclick="showDetail('${d.date}', 'dividend')">${formatCurrency(d.dividend_income)}</td>
                </tr>
            `;
        }).join('');
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value);
    }

    async function showDetail(date, type) {
        // モーダルを表示
        const modal = new bootstrap.Modal(document.getElementById('detailModal'));
        const modalTitle = document.getElementById('detailModalLabel');
        const detailContent = document.getElementById('detailContent');

        // 月次か日次かを判定 (YYYY-MM形式なら月次、YYYY-MM-DD形式なら日次)
        const isMonthly = date.length === 7 && date.split('-').length === 2;

        // タイトルを設定
        const typeNames = {
            'holding': 'A. 保有損益',
            'realized': 'B. 実現損益',
            'dividend': 'C. 受取配当'
        };
        modalTitle.textContent = `${date} - ${typeNames[type]} の詳細`;

        // キャッシュをチェック
        const cacheKey = `${date}_${type}`;
        if (detailCache[cacheKey]) {
            console.log(`Using cached detail for ${cacheKey}`);
            detailContent.innerHTML = detailCache[cacheKey];
            modal.show();
            return;
        }

        // ローディング表示
        detailContent.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">詳細データを読み込み中...</p>
            </div>
        `;

        modal.show();

        try {
            // キャッシュをチェック（日付レベル）
            let details;
            if (!detailCache[date]) {
                // APIから詳細データを取得
                console.log(`Fetching detail for ${date}...`);
                const response = await fetch(`/api/performance/detail?date=${date}`);

                if (!response.ok) {
                    console.error(`HTTP error! status: ${response.status}`);
                    detailContent.innerHTML = `<div class="alert alert-danger">HTTP エラー: ${response.status} ${response.statusText}</div>`;
                    return;
                }

                const result = await response.json();
                console.log(`API response for ${date}:`, result);

                if (!result.success) {
                    detailContent.innerHTML = `<div class="alert alert-danger">データの取得に失敗しました: ${result.error || '不明なエラー'}</div>`;
                    return;
                }

                // 日付レベルでキャッシュ
                detailCache[date] = result.details;
                details = result.details;
            } else {
                console.log(`Using cached API data for ${date}`);
                details = detailCache[date];
            }

            // タイプ別にHTMLを生成
            console.log(`Rendering ${type} for ${date}, isMonthly=${isMonthly}`);
            let html = '';
            if (type === 'holding') {
                html = renderHoldingDetails(details.holding_details, isMonthly);
            } else if (type === 'realized') {
                html = renderRealizedDetails(details.realized_details, isMonthly);
            } else if (type === 'dividend') {
                html = renderDividendDetails(details.dividend_details, isMonthly);
            }

            console.log(`HTML generated, length: ${html.length}`);

            // HTML生成結果もキャッシュ
            detailCache[cacheKey] = html;
            detailContent.innerHTML = html;

        } catch (error) {
            console.error('Error fetching detail:', error);
            console.error('Error stack:', error.stack);
            detailContent.innerHTML = `<div class="alert alert-danger">通信エラーが発生しました: ${error.message}</div>`;
        }
    }

    // モーダル内のソート状態を管理
    let modalSortState = {
        holding: { field: null, direction: 'asc' },
        realized: { field: null, direction: 'asc' },
        dividend: { field: null, direction: 'asc' }
    };
    let cachedDetails = {}; // 現在表示中の詳細データをキャッシュ

    function renderHoldingDetails(details, isMonthly = false) {
        if (details.length === 0) {
            return '<div class="alert alert-info">この日の保有損益はありません</div>';
        }

        // データをキャッシュに保存
        cachedDetails.holding = details;
        cachedDetails.holdingIsMonthly = isMonthly;

        const total = details.reduce((sum, d) => sum + d.pnl, 0);

        // 月次と日次でヘッダーを変更
        // 新規取得銘柄がある場合はヘッダーに両方のラベルを表示
        const hasNewThisMonth = isMonthly && details.some(d => d.is_new_this_month);
        const prevPriceLabel = isMonthly ? (hasNewThisMonth ? '前月末/取得価格' : '前月末株価') : '前日株価';
        const currPriceLabel = isMonthly ? '当月末株価' : '当日株価';

        // ソート状態に応じてクラスを設定
        const getSortClass = (field) => {
            if (modalSortState.holding.field === field) {
                return `modal-sortable ${modalSortState.holding.direction}`;
            }
            return 'modal-sortable';
        };

        let html = `
            <div class="detail-section">
                <h6>保有損益の内訳 (合計: ${formatCurrency(total)})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="holding-detail-table">
                        <thead class="table-light">
                            <tr>
                                <th class="${getSortClass('ticker_symbol')}" onclick="sortModalTable('holding', 'ticker_symbol')">ティッカー</th>
                                <th class="${getSortClass('security_name')}" onclick="sortModalTable('holding', 'security_name')">銘柄名</th>
                                <th class="text-end ${getSortClass('quantity')}" onclick="sortModalTable('holding', 'quantity')">保有数量</th>
                                <th class="text-end">${prevPriceLabel}</th>
                                <th class="text-end">${currPriceLabel}</th>
                                <th class="text-end ${getSortClass('price_change_pct')}" onclick="sortModalTable('holding', 'price_change_pct')">株価変動率</th>
                                <th class="text-end">為替レート</th>
                                <th class="text-end ${getSortClass('pnl')}" onclick="sortModalTable('holding', 'pnl')">損益</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        details.forEach(d => {
            const pnlClass = d.pnl >= 0 ? 'text-positive' : 'text-negative';
            // 変動率を計算
            const priceChangePct = d.prev_price > 0 ? ((d.curr_price - d.prev_price) / d.prev_price * 100) : 0;
            const changeClass = priceChangePct >= 0 ? 'text-positive' : 'text-negative';
            const exchangeRate = d.currency === 'JPY' ? '-' : d.exchange_rate.toFixed(2);
            // 新規取得銘柄の場合は「(取得)」ラベルを追加
            const prevPriceNote = (isMonthly && d.is_new_this_month) ? '<br><small class="text-muted">(取得価格)</small>' : '';

            html += `
                <tr>
                    <td><strong>${d.ticker_symbol}</strong></td>
                    <td>${d.security_name}</td>
                    <td class="text-end">${d.quantity.toLocaleString('ja-JP', {maximumFractionDigits: 2})}</td>
                    <td class="text-end">${d.prev_price.toLocaleString('ja-JP', {maximumFractionDigits: 2})} ${d.currency}${prevPriceNote}</td>
                    <td class="text-end">${d.curr_price.toLocaleString('ja-JP', {maximumFractionDigits: 2})} ${d.currency}</td>
                    <td class="text-end ${changeClass}">${priceChangePct >= 0 ? '+' : ''}${priceChangePct.toFixed(2)}%</td>
                    <td class="text-end">${exchangeRate}</td>
                    <td class="text-end fw-bold ${pnlClass}">${formatCurrency(d.pnl)}</td>
                </tr>
            `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        return html;
    }

    // モーダル内テーブルのソート機能
    function sortModalTable(type, field) {
        // ソート方向を切り替え
        if (modalSortState[type].field === field) {
            modalSortState[type].direction = modalSortState[type].direction === 'asc' ? 'desc' : 'asc';
        } else {
            modalSortState[type].field = field;
            modalSortState[type].direction = 'asc';
        }

        // キャッシュされたデータをソート
        let data;
        if (type === 'holding') {
            data = [...cachedDetails.holding];
            // 変動率の計算が必要な場合
            if (field === 'price_change_pct') {
                data.forEach(d => {
                    d.price_change_pct = d.prev_price > 0 ? ((d.curr_price - d.prev_price) / d.prev_price * 100) : 0;
                });
            }
        } else if (type === 'realized') {
            data = [...cachedDetails.realized];
        } else if (type === 'dividend') {
            data = [...cachedDetails.dividend];
        }

        if (!data) return;

        // ソート実行
        data.sort((a, b) => {
            let aVal = a[field];
            let bVal = b[field];

            // null/undefined の処理
            if (aVal == null) aVal = '';
            if (bVal == null) bVal = '';

            // 文字列の場合
            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            let comparison = 0;
            if (aVal > bVal) comparison = 1;
            else if (aVal < bVal) comparison = -1;

            return modalSortState[type].direction === 'asc' ? comparison : -comparison;
        });

        // 再描画
        const detailContent = document.getElementById('detailContent');
        if (type === 'holding') {
            cachedDetails.holding = data;
            detailContent.innerHTML = renderHoldingDetails(data, cachedDetails.holdingIsMonthly);
        } else if (type === 'realized') {
            cachedDetails.realized = data;
            detailContent.innerHTML = renderRealizedDetails(data, cachedDetails.realizedIsMonthly);
        } else if (type === 'dividend') {
            cachedDetails.dividend = data;
            detailContent.innerHTML = renderDividendDetails(data, cachedDetails.dividendIsMonthly);
        }
    }

    function renderRealizedDetails(details, isMonthly = false) {
        if (details.length === 0) {
            const message = isMonthly ? 'この月の実現損益はありません' : 'この日の実現損益はありません';
            return `<div class="alert alert-info">${message}</div>`;
        }

        // データをキャッシュに保存
        cachedDetails.realized = details;
        cachedDetails.realizedIsMonthly = isMonthly;

        const total = details.reduce((sum, d) => sum + d.pnl, 0);

        // ソート状態に応じてクラスを設定
        const getSortClass = (field) => {
            if (modalSortState.realized.field === field) {
                return `modal-sortable ${modalSortState.realized.direction}`;
            }
            return 'modal-sortable';
        };

        let html = `
            <div class="detail-section">
                <h6>実現損益の内訳 (合計: ${formatCurrency(total)})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="realized-detail-table">
                        <thead class="table-light">
                            <tr>
                                <th class="${getSortClass('ticker_symbol')}" onclick="sortModalTable('realized', 'ticker_symbol')">ティッカー</th>
                                <th class="${getSortClass('security_name')}" onclick="sortModalTable('realized', 'security_name')">銘柄名</th>
                                <th class="text-end ${getSortClass('quantity')}" onclick="sortModalTable('realized', 'quantity')">売却数量</th>
                                <th class="text-end ${getSortClass('average_cost')}" onclick="sortModalTable('realized', 'average_cost')">平均取得単価</th>
                                <th class="text-end ${getSortClass('sell_price')}" onclick="sortModalTable('realized', 'sell_price')">売却単価</th>
                                <th class="text-end ${getSortClass('pnl')}" onclick="sortModalTable('realized', 'pnl')">実現損益</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        details.forEach(d => {
            const pnlClass = d.pnl >= 0 ? 'text-positive' : 'text-negative';

            html += `
                <tr>
                    <td><strong>${d.ticker_symbol}</strong></td>
                    <td>${d.security_name}</td>
                    <td class="text-end">${d.quantity.toLocaleString('ja-JP', {maximumFractionDigits: 2})}</td>
                    <td class="text-end">${d.average_cost.toLocaleString('ja-JP', {maximumFractionDigits: 2})}</td>
                    <td class="text-end">${d.sell_price.toLocaleString('ja-JP', {maximumFractionDigits: 2})}</td>
                    <td class="text-end fw-bold ${pnlClass}">${formatCurrency(d.pnl)}</td>
                </tr>
            `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        return html;
    }

    function renderDividendDetails(details, isMonthly = false) {
        if (details.length === 0) {
            const message = isMonthly ? 'この月の配当受取はありません' : 'この日の配当受取はありません';
            return `<div class="alert alert-info">${message}</div>`;
        }

        // データをキャッシュに保存
        cachedDetails.dividend = details;
        cachedDetails.dividendIsMonthly = isMonthly;

        const total = details.reduce((sum, d) => sum + d.total_dividend, 0);

        // ソート状態に応じてクラスを設定
        const getSortClass = (field) => {
            if (modalSortState.dividend.field === field) {
                return `modal-sortable ${modalSortState.dividend.direction}`;
            }
            return 'modal-sortable';
        };

        let html = `
            <div class="detail-section">
                <h6>配当受取の内訳 (合計: ${formatCurrency(total)})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="dividend-detail-table">
                        <thead class="table-light">
                            <tr>
                                <th class="${getSortClass('ticker_symbol')}" onclick="sortModalTable('dividend', 'ticker_symbol')">ティッカー</th>
                                <th class="${getSortClass('security_name')}" onclick="sortModalTable('dividend', 'security_name')">銘柄名</th>
                                <th class="text-end ${getSortClass('quantity')}" onclick="sortModalTable('dividend', 'quantity')">保有数量</th>
                                <th class="text-end ${getSortClass('dividend_per_share')}" onclick="sortModalTable('dividend', 'dividend_per_share')">1株あたり配当</th>
                                <th class="text-end">為替レート</th>
                                <th class="text-end ${getSortClass('total_dividend')}" onclick="sortModalTable('dividend', 'total_dividend')">受取配当額</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        details.forEach(d => {
            const exchangeRate = d.currency === 'JPY' ? '-' : (d.exchange_rate ? d.exchange_rate.toFixed(2) : '-');

            html += `
                <tr>
                    <td><strong>${d.ticker_symbol}</strong></td>
                    <td>${d.security_name}</td>
                    <td class="text-end">${d.quantity ? d.quantity.toLocaleString('ja-JP', {maximumFractionDigits: 2}) : '-'}</td>
                    <td class="text-end">${d.dividend_per_share ? d.dividend_per_share.toLocaleString('ja-JP', {maximumFractionDigits: 4}) + ' ' + d.currency : '-'}</td>
                    <td class="text-end">${exchangeRate}</td>
                    <td class="text-end fw-bold text-positive">${formatCurrency(d.total_dividend)}</td>
                </tr>
            `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        return html;
    }

    function showError(msg) {
        document.getElementById('performance-chart').innerHTML = `<div class="alert alert-danger mx-5 mt-5">${msg}</div>`;
        document.getElementById('performance-tbody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">${msg}</td></tr>`;
    }

    function exportToCSV() {
        if (performanceData.length === 0) return;

        let csv = '日付,合計,A.保有損益,B.実現損益,C.受取配当\n';
        performanceData.forEach(d => {
            csv += `${d.date},${d.total},${d.holding_pnl},${d.realized_pnl},${d.dividend_income}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `performance_history_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}